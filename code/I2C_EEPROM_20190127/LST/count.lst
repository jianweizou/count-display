C51 COMPILER V9.54   COUNT                                                                 03/13/2019 21:07:10 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE COUNT
OBJECT MODULE PLACED IN .\Output\count.obj
COMPILER INVOKED BY: D:\keil\C51\BIN\C51.EXE Code\count.c ROM(COMPACT) OPTIMIZE(8,SIZE) BROWSE INCDIR(..\..\Include;..\I
                    -nclude) DEFINE(FOSC_160000) DEBUG OBJECTEXTEND PRINT(.\LST\count.lst) OBJECT(.\Output\count.obj)

line level    source

   1          #include "N76E003.h"
   2          #include "SFR_Macro.h"
   3          #include "count.h"
   4          #include "fontdata.h"
   5          #include "Function_define.h"
   6          #include "OLED.h"
   7          #include "dataflash.h"
   8          #include "ds1302.h"
   9          extern void Timer0_Init(void);
  10          extern void Timer1_Delay10ms(unsigned long cnt);
  11          extern void initADC(void);
  12          extern void Erase_LDROM(unsigned int datasize,unsigned int dataaddr);
  13          #define POWER_WAKEUP    1
  14          #if POWER_WAKEUP
  15          #define KEYINPUTMODE    P17_Input_Mode;P30_Input_Mode;P04_Input_Mode
  16          #else
              #define KEYINPUTMODE    P17_Input_Mode
              #endif
  19          #define GETKEY          P17
  20          
  21          unsigned char stage_loopcnt = 0;
  22          
  23          SysStruct       sysinfo;
  24          KEYTYPE keytype;
  25          unsigned char curKey,preKey;
  26          unsigned char debounce;
  27          unsigned char islongpress;
  28          unsigned char is_5ms_Flag;
  29          unsigned char blinktime;
  30          unsigned int powercnt;
  31          
  32          #if POWER_WAKEUP
  33          unsigned char power_debounce;
  34          bit  is_enter_charging;
  35          unsigned char las_stage;
  36          #endif
  37          #define BAT_LEVEL_BUF_0 0x860
  38          #define BAT_LEVEL_BUF_1 0x8C0
  39          #define BAT_LEVEL_BUF_2 0x920
  40          #define BAT_LEVEL_BUF_3 0x980
  41          
  42          unsigned int adcvalue[16];
  43          unsigned char adc_cnt;
  44          unsigned char batlevel=0xFF;
  45          bit isdisplaybaticon = 0;
  46          extern bit BIT_TMP;
  47          
  48          unsigned char ischangebatlevel_cnt = 0;
  49          unsigned char get_battery_time = 0;
  50          unsigned int val = 0;
  51          
  52          void KeyInit(void)
  53          {
  54   1              curKey = 0;
C51 COMPILER V9.54   COUNT                                                                 03/13/2019 21:07:10 PAGE 2   

  55   1              preKey = 1;
  56   1              debounce = 0;
  57   1              islongpress = 0;
  58   1              keytype = 0;
  59   1              KEYINPUTMODE;
  60   1              
  61   1              //
  62   1              #if POWER_WAKEUP
  63   1              power_debounce = 0;
  64   1              is_enter_charging = 0;
  65   1              #endif
  66   1      }
  67          
  68          void KeyScan(void)
  69          {
  70   1              if (is_5ms_Flag)
  71   1              {
  72   2                      is_5ms_Flag = 0;
  73   2                      curKey = GETKEY;
  74   2                      if (curKey != preKey)
  75   2                      {
  76   3                              preKey = curKey;
  77   3                              if ((islongpress == 0)&&(debounce > 10))
  78   3                              {
  79   4                                      keytype = SHORTKEY;
  80   4                              }
  81   3                              else if (islongpress >= 5)
  82   3                              {
  83   4                                      keytype = LONGKEY_12S;
  84   4                              }
  85   3                              else if (islongpress >= 3)
  86   3                              {
  87   4                                      keytype = LONGKEY_5S;
  88   4                              }
  89   3                              else if (islongpress >= 2)
  90   3                              {
  91   4                                      keytype = LONGKEY_2S;
  92   4                              }
  93   3                              debounce = 0;
  94   3                              islongpress = 0;
  95   3                              
  96   3                              powercnt = 0;
  97   3                      }
  98   2                      else if(curKey == 0)
  99   2                      {
 100   3                              debounce++;
 101   3                              if (debounce > 200)
 102   3                              {
 103   4                                      debounce = 0;
 104   4                                      islongpress++;
 105   4                              }
 106   3                              powercnt = 0;
 107   3                      }
 108   2                      #if POWER_WAKEUP
 109   2                      //5v power check
 110   2                      if (P30 == 0)
 111   2                      {
 112   3                              power_debounce = 0;
 113   3                              if (is_enter_charging == 1)
 114   3                              {
 115   4                                      is_enter_charging = 0;
 116   4                                      sysinfo.sysloop = las_stage;
C51 COMPILER V9.54   COUNT                                                                 03/13/2019 21:07:10 PAGE 3   

 117   4                                      sysinfo.isneedinitstage = 1;
 118   4                                      OLED_CLS_Windows(16,1,48,3);
 119   4                              }
 120   3                      }
 121   2                      else
 122   2                      {
 123   3                              powercnt = 0;
 124   3                              power_debounce++;
 125   3                              if (power_debounce > 10)
 126   3                              {
 127   4                                      //enter power charging
 128   4                                      power_debounce = 10;
 129   4                                      if (is_enter_charging == 0)
 130   4                                      {
 131   5                                              is_enter_charging = 1;
 132   5                                              las_stage = sysinfo.sysloop;
 133   5                                              sysinfo.sysloop = SYS_CHARGE;
 134   5                                              sysinfo.isneedinitstage = 1;
 135   5                                      }
 136   4                              }
 137   3                      }
 138   2                      #endif
 139   2              }
 140   1      }
 141          
 142          void display_Language_chinese(unsigned char isdisplay)
 143          {
 144   1              if (isdisplay == 1)
 145   1              {
 146   2                      Draw_BMP(16,0,16+16,2,(unsigned char *)(font_CHN + (ZHONG)*32));
 147   2                      Draw_BMP(32,0,32+16,2,font_CHN + (WEN)*32);
 148   2              }
 149   1              else
 150   1              {
 151   2                      OLED_CLS_Windows(16,0,48,2);
 152   2              }
 153   1      }
 154          void display_Language_english(unsigned char isdisplay)
 155          {
 156   1              char * en = "ENGLISH";
 157   1              char i;
 158   1              if (isdisplay == 1)
 159   1              {
 160   2                      for(i=0;i<7;i++)
 161   2                              Draw_BMP(4+8*i,2,4+8+8*i,4,font_A_Z + (en[i] - 'A')*16);
 162   2              }
 163   1              else
 164   1              {
 165   2                      OLED_CLS_Windows(4,2,60,4);
 166   2              }
 167   1      }
 168          void Select_Language(void)
 169          {
 170   1              if (sysinfo.isneedinitstage == 1)
 171   1              {
 172   2                      sysinfo.isneedinitstage = 0;
 173   2                      //init 
 174   2                      OLED_CLS_Windows(12,1,52,3);
 175   2                      display_Language_chinese(1);
 176   2                      display_Language_english(1);            
 177   2                      stage_loopcnt = sysinfo.language;
 178   2                      blinktime = (BLINK_H+BLINK_L);
C51 COMPILER V9.54   COUNT                                                                 03/13/2019 21:07:10 PAGE 4   

 179   2              }
 180   1              if (keytype != NULLKEY)
 181   1              {
 182   2                      if (keytype == SHORTKEY)
 183   2                      {
 184   3                              if (stage_loopcnt == CHINESE)
 185   3                              {
 186   4                                      display_Language_chinese(1);
 187   4                                      stage_loopcnt = ENGLISH;
 188   4                              }
 189   3                              else
 190   3                              {
 191   4                                      display_Language_english(1);
 192   4                                      stage_loopcnt = CHINESE;        
 193   4                              }
 194   3                              sysinfo.language = stage_loopcnt;
 195   3                      }
 196   2                      else if (keytype >= LONGKEY_2S)
 197   2                      {
 198   3                              sysinfo.language = stage_loopcnt;
 199   3                              sysinfo.sysloop = SELECT_NUMTYPE;
 200   3                              stage_loopcnt = 0;
 201   3                              blinktime = 0;
 202   3                              sysinfo.isneedinitstage = 1;
 203   3                              display_Language_english(0);
 204   3                              display_Language_chinese(0);
 205   3                      }
 206   2                      keytype = NULLKEY;
 207   2              }
 208   1              //blink
 209   1              if (blinktime == BLINK_H)
 210   1              {
 211   2                      if (sysinfo.language == CHINESE)
 212   2                              display_Language_chinese(0);
 213   2                      else
 214   2                              display_Language_english(0);
 215   2              }       
 216   1              else if (blinktime == (BLINK_H+BLINK_L))
 217   1              {
 218   2                      if (sysinfo.language == CHINESE)
 219   2                              display_Language_chinese(1);
 220   2                      else
 221   2                              display_Language_english(1);            
 222   2              }
 223   1      }
 224          
 225          
 226          unsigned int getdiv(unsigned long x,unsigned long y)
 227          {
 228   1              unsigned int div = 0;
 229   1              while(x >= y)
 230   1              {
 231   2                      div++;
 232   2                      x = x - y;
 233   2              }
 234   1              return div;
 235   1      }
 236          unsigned int getremainder(unsigned long x,unsigned long y)
 237          {
 238   1              while(x >= y)
 239   1              {
 240   2                      x = x - y;
C51 COMPILER V9.54   COUNT                                                                 03/13/2019 21:07:10 PAGE 5   

 241   2              }
 242   1              return x;
 243   1      }
 244          
 245          void display_cnt_stage_arabnum(unsigned char isdisplay)
 246          {
 247   1              char * nor = "NORMAL";
 248   1              char i;
 249   1              if (sysinfo.language == ENGLISH)
 250   1              {
 251   2                      if (isdisplay == 1)
 252   2                      {
 253   3                              for (i=0;i<6;i++)
 254   3                              {
 255   4                                      Draw_BMP(8 + i*8,0,8+8 + i*8,2,font_A_Z + (nor[i] - 'A')*16);
 256   4                              }
 257   3                      }
 258   2                      else
 259   2                      {
 260   3                              OLED_CLS_Windows(8,0,56,2);
 261   3                      }               
 262   2              }
 263   1              else
 264   1              {
 265   2                      if (isdisplay == 1)
 266   2                      {
 267   3                              Draw_BMP(16,0,16+16,2,font_CHN + (SHU)*32);
 268   3                              Draw_BMP(32,0,32+16,2,font_CHN + (ZI)*32);
 269   3                      }
 270   2                      else
 271   2                      {
 272   3                              OLED_CLS_Windows(16,0,48,2);
 273   3                      }
 274   2              }
 275   1      }
 276          void display_cnt_stage_tibnum(unsigned char isdisplay)
 277          {       
 278   1              char * nor = "TIBETAN";
 279   1              char i;
 280   1              if (sysinfo.language == ENGLISH)
 281   1              {
 282   2                      if (isdisplay == 1)
 283   2                      {
 284   3                              for (i=0;i<7;i++)
 285   3                              {
 286   4                                      Draw_BMP(4+ i*8,2,8+4+ i*8,4,font_A_Z + (nor[i] - 'A')*16);
 287   4                              }
 288   3                      }
 289   2                      else
 290   2                      {
 291   3                              OLED_CLS_Windows(4,2,60,4);
 292   3                      }               
 293   2              }
 294   1              else
 295   1              {
 296   2                      if (isdisplay == 1)
 297   2                      {
 298   3                              Draw_BMP(0,2,0+16,4,font_CHN + (ZANG)*32);
 299   3                              Draw_BMP(16,2,16+16,4,font_CHN + (WEN)*32);             
 300   3                              Draw_BMP(32,2,16+32,4,font_CHN + (SHU)*32);
 301   3                              Draw_BMP(48,2,48+16,4,font_CHN + (ZI)*32);
 302   3                      }
C51 COMPILER V9.54   COUNT                                                                 03/13/2019 21:07:10 PAGE 6   

 303   2                      else
 304   2                      {
 305   3                              OLED_CLS_Windows(0,2,64,4);
 306   3                      }
 307   2              }
 308   1      }
 309          void Select_NumType(void)
 310          {
 311   1              if (sysinfo.isneedinitstage == 1)
 312   1              {
 313   2                      sysinfo.isneedinitstage = 0;
 314   2                      display_cnt_stage_arabnum(1);
 315   2                      display_cnt_stage_tibnum(1);
 316   2                      stage_loopcnt = sysinfo.numtype;
 317   2                      blinktime = (BLINK_H+BLINK_L);
 318   2              }       
 319   1              if (keytype != NULLKEY)
 320   1              {
 321   2                      if (keytype == SHORTKEY)
 322   2                      {
 323   3                              if (stage_loopcnt == TIBENUM)
 324   3                              {
 325   4                                      display_cnt_stage_tibnum(1);
 326   4                                      stage_loopcnt = ARABNUM;
 327   4                              }
 328   3                              else
 329   3                              {
 330   4                                      display_cnt_stage_arabnum(1);
 331   4                                      stage_loopcnt = TIBENUM;
 332   4                              }
 333   3                              sysinfo.numtype = stage_loopcnt;
 334   3                      }
 335   2                      else if (keytype >= LONGKEY_2S)
 336   2                      {
 337   3                              sysinfo.sysloop = CNT_STAGE;
 338   3                              sysinfo.numtype = stage_loopcnt;
 339   3                              stage_loopcnt = 0;
 340   3                              blinktime = 0;
 341   3                              sysinfo.isneedinitstage = 1;
 342   3                              display_cnt_stage_arabnum(0);
 343   3                              display_cnt_stage_tibnum(0);                    
 344   3                      }
 345   2                      keytype = NULLKEY;
 346   2              }
 347   1              //blink
 348   1              if (blinktime == BLINK_H)
 349   1              {
 350   2                      if (stage_loopcnt == TIBENUM)
 351   2                              display_cnt_stage_tibnum(0);
 352   2                      else if (stage_loopcnt == ARABNUM)
 353   2                              display_cnt_stage_arabnum(0);
 354   2              }       
 355   1              else if (blinktime == (BLINK_H+BLINK_L))
 356   1              {
 357   2                      if (stage_loopcnt == TIBENUM)
 358   2                              display_cnt_stage_tibnum(1);
 359   2                      else if (stage_loopcnt == ARABNUM)
 360   2                              display_cnt_stage_arabnum(1);
 361   2              }       
 362   1      }
 363          void display_cnt_stage_cnt(unsigned long cnt,unsigned char isdisplay)
 364          {
C51 COMPILER V9.54   COUNT                                                                 03/13/2019 21:07:10 PAGE 7   

 365   1              
 366   1              unsigned char i;
 367   1              unsigned long temp;
 368   1              unsigned char nextdisplay=0; 
 369   1              unsigned char start_index=0;
 370   1              if (isdisplay == 0)
 371   1              {
 372   2                      OLED_CLS_Windows(0,2,64,4);
 373   2                      return;
 374   2              }
 375   1              temp = cnt;
 376   1              if (sysinfo.numtype == ARABNUM)
 377   1              {
 378   2                      
 379   2                      #define CNT_START_ARABNUM       12
 380   2                      #define ARABNUM_SIZE    8
 381   2                      start_index = CNT_START_ARABNUM;
 382   2                      i = getdiv(temp,10000);
 383   2                      temp = getremainder(temp,10000);
 384   2                      if (i != 0)
 385   2                      {
 386   3                              Draw_BMP(start_index,2,start_index+ARABNUM_SIZE,4,font2_0_9 + 16*i);
 387   3                              nextdisplay = 1;
 388   3                              start_index+=ARABNUM_SIZE;
 389   3                      }
 390   2                      else
 391   2                      {
 392   3                              start_index+=ARABNUM_SIZE>>1;
 393   3                      }
 394   2                      
 395   2                      i = getdiv(temp,1000);
 396   2                      temp = getremainder(temp,1000);
 397   2                      if ((nextdisplay == 1)||(i != 0))
 398   2                      {
 399   3                              nextdisplay = 1;
 400   3                              Draw_BMP(start_index,2,start_index+ARABNUM_SIZE,4,font2_0_9 + 16*i);
 401   3                              start_index+=ARABNUM_SIZE;
 402   3                      }
 403   2                      else
 404   2                      {
 405   3                              start_index+=ARABNUM_SIZE>>1;
 406   3                      }
 407   2                      
 408   2                      i = getdiv(temp,100);
 409   2                      temp = getremainder(temp,100);
 410   2                      if ((nextdisplay == 1)||(i != 0))
 411   2                      {
 412   3                              nextdisplay = 1;
 413   3                              Draw_BMP(start_index,2,start_index+ARABNUM_SIZE,4,font2_0_9 + 16*i);
 414   3                              start_index+=ARABNUM_SIZE;
 415   3                      }
 416   2                      else
 417   2                      {
 418   3                              start_index+=ARABNUM_SIZE>>1;
 419   3                      }
 420   2                      
 421   2                      i = getdiv(temp,10);
 422   2                      temp = getremainder(temp,10);
 423   2                      if ((nextdisplay == 1)||(i != 0))
 424   2                      {
 425   3                              nextdisplay = 1;
 426   3                              Draw_BMP(start_index,2,start_index+ARABNUM_SIZE,4,font2_0_9 + 16*i);
C51 COMPILER V9.54   COUNT                                                                 03/13/2019 21:07:10 PAGE 8   

 427   3                              start_index+=ARABNUM_SIZE;
 428   3                      }
 429   2                      else
 430   2                      {
 431   3                              start_index+=ARABNUM_SIZE>>1;
 432   3                      }
 433   2                      
 434   2                      i = temp;
 435   2                      Draw_BMP(start_index,2,start_index+ARABNUM_SIZE,4,font2_0_9 + 16*i);
 436   2              }
 437   1              else
 438   1              {
 439   2                      #define CNT_START_TIBENUM       2
 440   2                      #define TIBENUM_SIZE    12
 441   2                      start_index = CNT_START_TIBENUM;
 442   2                      i = getdiv(temp,10000);
 443   2                      temp = getremainder(temp,10000);
 444   2                      if (i != 0)
 445   2                      {
 446   3                              Draw_BMP(start_index,2,start_index+TIBENUM_SIZE,4,t0 + 24*i);
 447   3                              nextdisplay = 1;
 448   3                              start_index+=TIBENUM_SIZE;
 449   3                      }
 450   2                      else
 451   2                              start_index+=TIBENUM_SIZE>>1;
 452   2                      
 453   2                      i = getdiv(temp,1000);
 454   2                      temp = getremainder(temp,1000);
 455   2                      if ((nextdisplay == 1)||(i != 0))
 456   2                      {
 457   3                              Draw_BMP(start_index,2,start_index+TIBENUM_SIZE,4,t0 + 24*i);
 458   3                              nextdisplay = 1;
 459   3                              start_index+=TIBENUM_SIZE;
 460   3                      }
 461   2                      else
 462   2                              start_index+=TIBENUM_SIZE>>1;
 463   2                      
 464   2                      i = getdiv(temp,100);
 465   2                      temp = getremainder(temp,100);
 466   2                      if ((nextdisplay == 1)||(i != 0))
 467   2                      {
 468   3                              Draw_BMP(start_index,2,start_index+TIBENUM_SIZE,4,t0 + 24*i);
 469   3                              nextdisplay = 1;
 470   3                              start_index+=TIBENUM_SIZE;
 471   3                      }
 472   2                      else
 473   2                              start_index+=TIBENUM_SIZE>>1;
 474   2                      
 475   2                      i = getdiv(temp,10);
 476   2                      temp = getremainder(temp,10);
 477   2                      if ((nextdisplay == 1)||(i != 0))
 478   2                      {
 479   3                              Draw_BMP(start_index,2,start_index+TIBENUM_SIZE,4,t0 + 24*i);
 480   3                              nextdisplay = 1;
 481   3                              start_index+=TIBENUM_SIZE;
 482   3                      }
 483   2                      else
 484   2                              start_index+=TIBENUM_SIZE>>1;
 485   2                      
 486   2                      i = temp;
 487   2                      Draw_BMP(start_index,2,start_index+TIBENUM_SIZE,4,t0 + 24*i);   
 488   2              }
C51 COMPILER V9.54   COUNT                                                                 03/13/2019 21:07:10 PAGE 9   

 489   1      }
 490          
 491          
 492          
 493          unsigned char getbatlever(unsigned char ischarging)
 494          {
 495   1              unsigned char i,j;
 496   1              unsigned int curval = 0;
 497   1              unsigned char temp=0xFF;
 498   1              if (adc_cnt >= 16)
 499   1              {
 500   2                      clr_EADC;
 501   2                      adc_cnt = 0;
 502   2                      for(i=0;i<16;i++)
 503   2                      {
 504   3                              for (j = i+1;j<16;j++)
 505   3                              {
 506   4                                      curval = adcvalue[j];
 507   4                                      if (curval > adcvalue[i])
 508   4                                      {
 509   5                                              adcvalue[j] = adcvalue[i];
 510   5                                              adcvalue[i] = curval;
 511   5                                      }
 512   4                              }
 513   3                      }
 514   2                      curval = 0;
 515   2                      for (i = 4; i<12;i++)
 516   2                              curval+=adcvalue[i];
 517   2                      curval = curval>>3;
 518   2                      if (ischarging == 1)
 519   2                              curval -= 0x20;
 520   2                      
 521   2                      
 522   2                      if (val == 0)
 523   2                              val = curval;
 524   2                      else
 525   2                      {                       
 526   3                              if (curval > (val+5))
 527   3                              {
 528   4                                      val++;
 529   4                                      return 0xFF;
 530   4                                      //curval = val+5;
 531   4                              }
 532   3                              else if ((curval+5) < val)
 533   3                              {
 534   4                                      val--;
 535   4                                      return 0xFF;
 536   4                                      //curval = val-5;
 537   4                              }
 538   3                              else if ((curval+20) < val)
 539   3                              {
 540   4                                      val = curval + 20;
 541   4                              }
 542   3      //                      curval = curval >> 1;
 543   3      //                      val = val >> 1;
 544   3                              curval = (curval +val) >> 1;
 545   3                              if (ischarging == 1)
 546   3                              {                               
 547   4                                      if (curval > val)
 548   4                                      {
 549   5                                              val = curval;
 550   5      //                                      val = val << 1;
C51 COMPILER V9.54   COUNT                                                                 03/13/2019 21:07:10 PAGE 10  

 551   5                                      }
 552   4                              }
 553   3                              else
 554   3                              {
 555   4                                      if (val > curval)
 556   4                                      {
 557   5                                              val = curval;
 558   5      //                                      val = val << 1;
 559   5                                      }
 560   4                              }
 561   3                              
 562   3                      }
 563   2                      
 564   2                      
 565   2                      if (isdisplaybaticon == 0)
 566   2                      {
 567   3                              if (val > BAT_LEVEL_BUF_3)
 568   3                                      temp =  4;
 569   3                              else if (val > BAT_LEVEL_BUF_2)
 570   3                                      temp =  3;
 571   3                              else if (val > BAT_LEVEL_BUF_1)
 572   3                                      temp =  2;
 573   3                              else if (val > BAT_LEVEL_BUF_0)
 574   3                                      temp =  1;
 575   3                              else 
 576   3                                      temp =  0;
 577   3                              ischangebatlevel_cnt = 0;
 578   3      //                      set_EADC;
 579   3                      }
 580   2                      else
 581   2                      {
 582   3                              if (val < (BAT_LEVEL_BUF_0 - 0x08))
 583   3                                      temp =  0;
 584   3                              else if ((val > (BAT_LEVEL_BUF_0 + 0x08))&&(val < (BAT_LEVEL_BUF_1 - 0x08)))
 585   3                              {
 586   4                                      temp =  1;
 587   4                              }
 588   3                              else if ((val > (BAT_LEVEL_BUF_1+ 0x08))&&(val < (BAT_LEVEL_BUF_2 - 0x08)))
 589   3                              {
 590   4                                      temp =  2;
 591   4                              }
 592   3                              else if ((val > (BAT_LEVEL_BUF_2 + 0x08))&&(val < (BAT_LEVEL_BUF_3 - 0x08)))
 593   3                              {
 594   4                                      temp =  3;
 595   4                              }
 596   3                              else if (val > (BAT_LEVEL_BUF_3 + 0x08))
 597   3                              {
 598   4                                      temp =  4;
 599   4                              }
 600   3                              
 601   3                              if (temp != batlevel)
 602   3                              {
 603   4                                      ischangebatlevel_cnt++;
 604   4                                      if (ischangebatlevel_cnt < 5)
 605   4                                      {
 606   5                                              temp = batlevel;
 607   5                                      }
 608   4                                      else
 609   4                                      {
 610   5                                              ischangebatlevel_cnt = 0;
 611   5      //                                      if (ischarging == 1)
 612   5      //                                      {
C51 COMPILER V9.54   COUNT                                                                 03/13/2019 21:07:10 PAGE 11  

 613   5      //                                              if (temp <= batlevel)
 614   5      //                                                      temp = batlevel;
 615   5      //                                      }
 616   5      //                                      else
 617   5      //                                      {
 618   5      //                                              if (temp >= batlevel)
 619   5      //                                                      temp = batlevel;
 620   5      //                                      }
 621   5                                      }
 622   4                              }
 623   3                              else
 624   3                                      ischangebatlevel_cnt = 0;
 625   3                      }
 626   2      //              set_EADC;
 627   2              }
 628   1              return temp;
 629   1      }
 630          
 631          void display_baticonlevel(unsigned char level)
 632          {
 633   1              unsigned char *buf;
 634   1              if (level > 4)
 635   1                      level = 4;
 636   1      //      if (level == 0)
 637   1      //      {
 638   1      //              for (i = 0; i < 8;i++)
 639   1      //              {
 640   1      //                      baticon[4+i] = 0x18;
 641   1      //                      baticon[20+i] = 0x0C;
 642   1      //              }
 643   1      //      }
 644   1      //      else if(level == 1)
 645   1      //      {
 646   1      //              for (i = 0; i < 2;i++)
 647   1      //              {
 648   1      //                      baticon[4+i] = 0xF8;
 649   1      //                      baticon[20+i] = 0x0F;
 650   1      //              }
 651   1      //              for (i = 2; i < 8;i++)
 652   1      //              {
 653   1      //                      baticon[4+i] = 0x18;
 654   1      //                      baticon[20+i] = 0x0C;
 655   1      //              }
 656   1      //      }
 657   1      //      else if(level == 2)
 658   1      //      {
 659   1      //              for (i = 0; i < 4;i++)
 660   1      //              {
 661   1      //                      baticon[4+i] = 0xF8;
 662   1      //                      baticon[20+i] = 0x0F;
 663   1      //              }
 664   1      //              for (i = 4; i < 8;i++)
 665   1      //              {
 666   1      //                      baticon[4+i] = 0x18;
 667   1      //                      baticon[20+i] = 0x0C;
 668   1      //              }
 669   1      //      }
 670   1      //      else if(level == 3)
 671   1      //      {
 672   1      //              for (i = 0; i < 6;i++)
 673   1      //              {
 674   1      //                      baticon[4+i] = 0xF8;
C51 COMPILER V9.54   COUNT                                                                 03/13/2019 21:07:10 PAGE 12  

 675   1      //                      baticon[20+i] = 0x0F;
 676   1      //              }
 677   1      //              for (i = 6; i < 8;i++)
 678   1      //              {
 679   1      //                      baticon[4+i] = 0x18;
 680   1      //                      baticon[20+i] = 0x0C;
 681   1      //              }
 682   1      //      }
 683   1      //      else
 684   1      //      {
 685   1      //              for (i = 0; i < 8;i++)
 686   1      //              {
 687   1      //                      baticon[4+i] = 0xF8;
 688   1      //                      baticon[20+i] = 0x0F;
 689   1      //              }
 690   1      //      }
 691   1              buf = (unsigned char *)baticon + (level * 32);
 692   1              isdisplaybaticon = 1;
 693   1              Draw_BMP(0,0,16,2,buf);
 694   1      }
 695          
 696          void display_baticon(void)
 697          {
 698   1              unsigned char level;
 699   1              level = getbatlever(0);
 700   1              if (level != 0xFF)
 701   1              {
 702   2                      if (batlevel != level)
 703   2                      {
 704   3                              batlevel = level;
 705   3                              display_baticonlevel(batlevel);
 706   3                      }
 707   2                      sysinfo.lastpower = level;
 708   2                      adc_cnt = 0;
 709   2      //              set_EADC;
 710   2              }
 711   1      }
 712          
 713          void Cnt_Stage(void)
 714          {               
 715   1              if (sysinfo.isneedinitstage == 1)
 716   1              {
 717   2                      sysinfo.isneedinitstage = 0;
 718   2                      blinktime = 0;
 719   2                      isdisplaybaticon = 0;           
 720   2      //              display_cnt_stage_date(1);
 721   2      //              initADC();
 722   2                      display_cnt_stage_cnt(sysinfo.totalcnt,1);
 723   2      //              if (sysinfo.lastpower == 0xFF)
 724   2                      {
 725   3                              isdisplaybaticon = 0;
 726   3                              sysinfo.lastpower = getbatlever(0);                     
 727   3                      }
 728   2                      batlevel = sysinfo.lastpower;
 729   2                      display_baticonlevel(sysinfo.lastpower);
 730   2                      
 731   2              }
 732   1      
 733   1              display_baticon();
 734   1      
 735   1      //      if (powercnt == 20)
 736   1      //      {
C51 COMPILER V9.54   COUNT                                                                 03/13/2019 21:07:10 PAGE 13  

 737   1      //              powercnt = 0;
 738   1      //              sysinfo.totalcnt++;
 739   1      //              if (sysinfo.totalcnt > 99999)
 740   1      //                              sysinfo.totalcnt = 0;
 741   1      //              display_cnt_stage_cnt(sysinfo.totalcnt,1);
 742   1      //      }
 743   1              
 744   1              if (keytype != NULLKEY)
 745   1              {
 746   2      //              sysinfo.totalcnt = val;
 747   2      //              display_cnt_stage_cnt(sysinfo.totalcnt,1);
 748   2                      if (keytype == SHORTKEY)
 749   2                      {
 750   3                              sysinfo.totalcnt++;
 751   3                              if (sysinfo.totalcnt > 99999)
 752   3                              {
 753   4                                      sysinfo.totalcnt = 0;
 754   4                                      display_cnt_stage_cnt(0,0);     
 755   4                              }
 756   3                              display_cnt_stage_cnt(sysinfo.totalcnt,1);
 757   3                      }
 758   2                      else if (keytype == LONGKEY_5S)
 759   2                      {
 760   3                              sysinfo.sysloop = RST_CNT;
 761   3                              sysinfo.isneedinitstage = 1;
 762   3                              stage_loopcnt = 0;
 763   3      //                      batlevel = 0xFF;
 764   3                              OLED_CLS_Windows(0,0,64,2);
 765   3      //                      display_cnt_stage_date(0);
 766   3                              display_cnt_stage_cnt(0,0);                     
 767   3                      }
 768   2                      else if (keytype == LONGKEY_12S)
 769   2                      {
 770   3                              sysinfo.sysloop = RST_SYS;
 771   3                              sysinfo.isneedinitstage = 1;
 772   3                              stage_loopcnt = 0;
 773   3      //                      batlevel = 0xFF;
 774   3                              OLED_CLS_Windows(0,0,64,2);
 775   3      //                      display_cnt_stage_date(0);
 776   3                              display_cnt_stage_cnt(0,0);                     
 777   3                      }
 778   2                      keytype = NULLKEY;
 779   2              }
 780   1      }
 781          
 782          
 783          void display_rst_cnt_stage_1(unsigned char isdisplay)
 784          {
 785   1              char i;
 786   1              char * en = "RST";
 787   1              char * en1 = "CNT";
 788   1              if (sysinfo.language == ENGLISH)
 789   1              {
 790   2                      if (isdisplay == 1)
 791   2                      {
 792   3                              for (i=0;i<3;i++)
 793   3                              {
 794   4                                      Draw_BMP(6+i*8,0,8+6 + i*8,2,font_A_Z + (en[i]-'A')*16);
 795   4                                      Draw_BMP(32+ i*8,0,8+32+ i*8,2,font_A_Z + (en1[i]-'A')*16);
 796   4                              }
 797   3                      }
 798   2                      else
C51 COMPILER V9.54   COUNT                                                                 03/13/2019 21:07:10 PAGE 14  

 799   2                      {
 800   3                              OLED_CLS_Windows(6,0,56,2);
 801   3                      }               
 802   2              }
 803   1              else
 804   1              {
 805   2                      if (isdisplay == 1)
 806   2                      {
 807   3                              Draw_BMP(16,0,16+16,2,font_CHN + (GUI)*32);
 808   3                              Draw_BMP(32,0,32+16,2,font_CHN + (LING)*32);
 809   3                      }
 810   2                      else
 811   2                      {
 812   3                              OLED_CLS_Windows(16,0,48,2);
 813   3                      }
 814   2              }
 815   1      }
 816          void display_rst_cnt_stage_yes(unsigned char isdisplay)
 817          {
 818   1              char i;
 819   1              char * en = "YES";
 820   1              if (sysinfo.language == ENGLISH)
 821   1              {
 822   2                      if (isdisplay == 1)
 823   2                      {
 824   3                              for (i=0;i<3;i++)
 825   3                              {
 826   4                                      Draw_BMP(10+i*8,2,8+10 + i*8,4,font_A_Z + (en[i]-'A')*16);
 827   4                              }
 828   3                      }
 829   2                      else
 830   2                      {
 831   3                              OLED_CLS_Windows(10,2,34,4);
 832   3                      }               
 833   2              }
 834   1              else    
 835   1              {
 836   2                      if (isdisplay == 1)
 837   2                      {
 838   3                              Draw_BMP(12,2,12+16,4,font_CHN + (SHI)*32);
 839   3                      }
 840   2                      else
 841   2                      {
 842   3                              OLED_CLS_Windows(12,2,28,4);
 843   3                      }       
 844   2              }
 845   1      }
 846          void display_rst_cnt_stage_no(unsigned char isdisplay)
 847          {
 848   1              char i;
 849   1              char * en = "NO";
 850   1              if (sysinfo.language == ENGLISH)
 851   1              {
 852   2                      if (isdisplay == 1)
 853   2                      {
 854   3                              for (i=0;i<2;i++)
 855   3                              {
 856   4                                      Draw_BMP(38+i*8,2,8+38 + i*8,4,font_A_Z + (en[i]-'A')*16);
 857   4                              }
 858   3                      }
 859   2                      else
 860   2                      {
C51 COMPILER V9.54   COUNT                                                                 03/13/2019 21:07:10 PAGE 15  

 861   3                              OLED_CLS_Windows(38,2,54,4);
 862   3                      }               
 863   2              }
 864   1              else    
 865   1              {       
 866   2                      if (isdisplay == 1)
 867   2                      {
 868   3                              Draw_BMP(36,2,36+16,4,font_CHN + (FOU)*32);
 869   3                      }
 870   2                      else
 871   2                      {
 872   3                              OLED_CLS_Windows(36,2,52,4);
 873   3                      }
 874   2              }       
 875   1      }
 876          void Rst_Cnt_Stage(void)
 877          {
 878   1              if (sysinfo.isneedinitstage == 1)
 879   1              {
 880   2                      sysinfo.isneedinitstage = 0;
 881   2                      display_rst_cnt_stage_1(1);
 882   2                      display_rst_cnt_stage_yes(1);
 883   2                      display_rst_cnt_stage_no(1);
 884   2                      blinktime = (BLINK_H+BLINK_L);
 885   2              }
 886   1              if (keytype != NULLKEY)
 887   1              {
 888   2                      if (keytype == SHORTKEY)
 889   2                      {
 890   3                              if (stage_loopcnt == YES)
 891   3                              {
 892   4                                      display_rst_cnt_stage_yes(1);
 893   4                                      stage_loopcnt = NO;
 894   4                              }
 895   3                              else
 896   3                              {
 897   4                                      stage_loopcnt = YES;
 898   4                                      display_rst_cnt_stage_no(1);
 899   4                              }
 900   3                      }
 901   2                      else if (keytype >= LONGKEY_2S)
 902   2                      {
 903   3                              if (stage_loopcnt == 0)//yes
 904   3                                      sysinfo.totalcnt = 0;
 905   3                              sysinfo.sysloop = CNT_STAGE;
 906   3                              stage_loopcnt = 0;
 907   3                              blinktime = 0;
 908   3      //                      batlevel = 0xff;
 909   3                              sysinfo.isneedinitstage = 1;
 910   3                              display_rst_cnt_stage_1(0);
 911   3                              display_rst_cnt_stage_yes(0);
 912   3                              display_rst_cnt_stage_no(0);                    
 913   3                      }
 914   2                      keytype = NULLKEY;
 915   2              }
 916   1              //blink
 917   1              if (blinktime == BLINK_H)
 918   1              {
 919   2                      if (stage_loopcnt == YES)
 920   2                              display_rst_cnt_stage_yes(0);
 921   2                      else if (stage_loopcnt == NO)
 922   2                              display_rst_cnt_stage_no(0);
C51 COMPILER V9.54   COUNT                                                                 03/13/2019 21:07:10 PAGE 16  

 923   2              }       
 924   1              else if (blinktime == (BLINK_H+BLINK_L))
 925   1              {
 926   2                      if (stage_loopcnt == YES)
 927   2                              display_rst_cnt_stage_yes(1);
 928   2                      else if (stage_loopcnt == NO)
 929   2                              display_rst_cnt_stage_no(1);
 930   2              }       
 931   1      }
 932          
 933          void display_rst_sys_stage_1(unsigned char isdisplay)
 934          {
 935   1              char i;
 936   1              char * en = "RST";
 937   1              char * en1 = "DEV";
 938   1              if (sysinfo.language == ENGLISH)
 939   1              {
 940   2                      if (isdisplay == 1)
 941   2                      {
 942   3                              for (i=0;i<3;i++)
 943   3                              {
 944   4                                      Draw_BMP(6+i*8,0,8+6 + i*8,2,font_A_Z + (en[i]-'A')*16);
 945   4                                      Draw_BMP(32+ i*8,0,8+32+ i*8,2,font_A_Z + (en1[i]-'A')*16);
 946   4                              }
 947   3                      }
 948   2                      else
 949   2                      {
 950   3                              OLED_CLS_Windows(6,0,56,2);
 951   3                      }               
 952   2              }
 953   1              else
 954   1              {       
 955   2                      if (isdisplay == 1)
 956   2                      {
 957   3                              Draw_BMP(16,0,16+16,2,font_CHN + (CHONG)*32);
 958   3                              Draw_BMP(32,0,32+16,2,font_CHN + (ZHI)*32);
 959   3                      }
 960   2                      else
 961   2                      {
 962   3                              OLED_CLS_Windows(16,0,48,2);
 963   3                      }
 964   2              }
 965   1      }
 966          
 967          void Rst_Sys_Stage(void)
 968          {
 969   1              if (sysinfo.isneedinitstage == 1)
 970   1              {
 971   2                      sysinfo.isneedinitstage = 0;
 972   2                      display_rst_sys_stage_1(1);
 973   2                      display_rst_cnt_stage_yes(1);
 974   2                      display_rst_cnt_stage_no(1);    
 975   2                      blinktime = (BLINK_H+BLINK_L);
 976   2              }
 977   1              if (keytype != NULLKEY)
 978   1              {
 979   2                      if (keytype == SHORTKEY)
 980   2                      {
 981   3                              if (stage_loopcnt == YES)
 982   3                              {
 983   4                                      display_rst_cnt_stage_yes(1);
 984   4                                      stage_loopcnt = NO;
C51 COMPILER V9.54   COUNT                                                                 03/13/2019 21:07:10 PAGE 17  

 985   4                              }
 986   3                              else
 987   3                              {
 988   4                                      stage_loopcnt = YES;
 989   4                                      display_rst_cnt_stage_no(1);    
 990   4                              }
 991   3                      }
 992   2                      else if (keytype >= LONGKEY_2S)
 993   2                      {
 994   3                              display_rst_sys_stage_1(0);
 995   3                              display_rst_cnt_stage_yes(0);   
 996   3                              display_rst_cnt_stage_no(0);    
 997   3                              if (stage_loopcnt == 0)
 998   3                              {
 999   4                                      sysinfo.sysloop = SYSINIT;
1000   4                              }
1001   3                              else
1002   3                                      sysinfo.sysloop = CNT_STAGE;
1003   3                              stage_loopcnt = 0;
1004   3                              sysinfo.isneedinitstage = 1;
1005   3      //                      batlevel = 0xff;
1006   3                      }
1007   2                      keytype = NULLKEY;
1008   2              }
1009   1              //blink
1010   1              if (blinktime == BLINK_H)
1011   1              {
1012   2                      if (stage_loopcnt == YES)
1013   2                              display_rst_cnt_stage_yes(0);
1014   2                      else if (stage_loopcnt == NO)
1015   2                              display_rst_cnt_stage_no(0);
1016   2              }       
1017   1              else if (blinktime == (BLINK_H+BLINK_L))
1018   1              {
1019   2                      if (stage_loopcnt == YES)
1020   2                              display_rst_cnt_stage_yes(1);
1021   2                      else if (stage_loopcnt == NO)
1022   2                              display_rst_cnt_stage_no(1);
1023   2              }               
1024   1      }
1025          
1026          #if POWER_WAKEUP
1027          void display_baticonlevel_charging(unsigned char level)
1028          {
1029   1              unsigned char *buf;
1030   1              if (level > 4)
1031   1                      level = 4;
1032   1      //      if (level == 0)
1033   1      //      {
1034   1      //              for (i = 0; i < 24;i++)
1035   1      //              {
1036   1      //                      chargeicon[2+i] = 0x03;
1037   1      //                      chargeicon[34+i] = 0xC0;
1038   1      //              }
1039   1      //      }
1040   1      //      else if(level == 1)
1041   1      //      {
1042   1      //              for (i = 0; i < 6;i++)
1043   1      //              {
1044   1      //                      chargeicon[2+i] = 0xFF;
1045   1      //                      chargeicon[34+i] = 0xFF;
1046   1      //              }
C51 COMPILER V9.54   COUNT                                                                 03/13/2019 21:07:10 PAGE 18  

1047   1      //              for (i = 6; i < 24;i++)
1048   1      //              {
1049   1      //                      chargeicon[2+i] = 0x03;
1050   1      //                      chargeicon[34+i] = 0xC0;
1051   1      //              }
1052   1      //      }
1053   1      //      else if(level == 2)
1054   1      //      {
1055   1      //              for (i = 0; i < 12;i++)
1056   1      //              {
1057   1      //                      chargeicon[2+i] = 0xFF;
1058   1      //                      chargeicon[34+i] = 0xFF;
1059   1      //              }
1060   1      //              for (i = 12; i < 24;i++)
1061   1      //              {
1062   1      //                      chargeicon[2+i] = 0x03;
1063   1      //                      chargeicon[34+i] = 0xC0;
1064   1      //              }
1065   1      //      }
1066   1      //      else if(level == 3)
1067   1      //      {
1068   1      //              for (i = 0; i < 18;i++)
1069   1      //              {
1070   1      //                      chargeicon[2+i] = 0xFF;
1071   1      //                      chargeicon[34+i] = 0xFF;
1072   1      //              }
1073   1      //              for (i = 18; i < 24;i++)
1074   1      //              {
1075   1      //                      chargeicon[2+i] = 0x03;
1076   1      //                      chargeicon[34+i] = 0xC0;
1077   1      //              }
1078   1      //      }
1079   1      //      else
1080   1      //      {
1081   1      //              for (i = 0; i < 24;i++)
1082   1      //              {
1083   1      //                      chargeicon[2+i] = 0xFF;
1084   1      //                      chargeicon[34+i] = 0xFF;
1085   1      //              }
1086   1      //      }
1087   1              buf = (unsigned char*)chargeicon + (64*level);
1088   1              isdisplaybaticon = 1;
1089   1              Draw_BMP(16,1,16+32,3,buf);
1090   1      }
1091          
1092          
1093          void Sys_Charge_Stage(void)
1094          {
1095   1              unsigned char level;
1096   1              if (sysinfo.isneedinitstage == 1)
1097   1              {
1098   2                      sysinfo.isneedinitstage = 0;    
1099   2                      OLED_CLS_Windows(0,0,64,4);
1100   2      //              initADC();              
1101   2                      if (sysinfo.lastpower == 0xFF)
1102   2                      {
1103   3                              isdisplaybaticon = 0;
1104   3                              sysinfo.lastpower = getbatlever(1);                     
1105   3                      }
1106   2                      batlevel = sysinfo.lastpower;
1107   2                      display_baticonlevel_charging(sysinfo.lastpower);
1108   2                      blinktime = 0;
C51 COMPILER V9.54   COUNT                                                                 03/13/2019 21:07:10 PAGE 19  

1109   2              }
1110   1              if (keytype != NULLKEY)
1111   1              {
1112   2                      keytype = NULLKEY;
1113   2              }
1114   1              //blink
1115   1              if (blinktime == (BLINK_H+BLINK_L))
1116   1              {                       
1117   2      //              level = getbatlever(1);
1118   2      //              sysinfo.totalcnt = val;
1119   2      //              display_cnt_stage_cnt(sysinfo.totalcnt,1);
1120   2                      level = getbatlever(1);
1121   2                      if (level != 0xFF)
1122   2                      {
1123   3                              if (batlevel != level)
1124   3                              {
1125   4                                      batlevel = level;
1126   4                                      //display bat
1127   4                                      display_baticonlevel_charging(batlevel);
1128   4                              }
1129   3                              sysinfo.lastpower = level;
1130   3                              adc_cnt = 0;                    
1131   3                      }
1132   2              }               
1133   1      }
1134          #endif
1135          void SysLoop(void)
1136          {
1137   1              switch(sysinfo.sysloop)
1138   1              {
1139   2                      case SELECT_LANGUAGE:
1140   2                              Select_Language();
1141   2                              break;
1142   2                      case SELECT_NUMTYPE:
1143   2                              Select_NumType();
1144   2                              break;
1145   2                      case CNT_STAGE:
1146   2                              Cnt_Stage();
1147   2                              break;
1148   2                      case RST_CNT:
1149   2                              Rst_Cnt_Stage();
1150   2                              break;
1151   2                      case RST_SYS:
1152   2                              Rst_Sys_Stage();
1153   2                              break;
1154   2                      #if POWER_WAKEUP
1155   2                      case SYS_CHARGE:
1156   2                              Sys_Charge_Stage();
1157   2                              break;
1158   2                      #endif
1159   2                      default:break;
1160   2              }
1161   1      }
1162          void PinInterrupt_ISR (void) interrupt 7
1163          {
1164   1              PIF = 0;
1165   1      }
1166          void EXT_INT0(void) interrupt 0
1167          {
1168   1              
1169   1      }
1170          
C51 COMPILER V9.54   COUNT                                                                 03/13/2019 21:07:10 PAGE 20  

1171          void EXT_INT1(void) interrupt 2
1172          {
1173   1              
1174   1      }
1175          void P30_init(void){
1176   1              P30_Input_Mode;
1177   1              set_P3S_0;
1178   1      //      set_IT0;
1179   1      //      set_EX0;
1180   1      //      
1181   1      //      Enable_BIT0_RasingEdge_Trig;
1182   1              PICON|=0x04;PINEN&=0xFE;PIPEN|=0x01;
1183   1              Enable_INT_Port3;
1184   1              set_EPI;
1185   1              
1186   1              set_EA;
1187   1      }
1188          void exti1_init(void){
1189   1              P17_Input_Mode;
1190   1              set_P1S_7;
1191   1              set_EX1;
1192   1              set_EA;
1193   1      }
1194          void Enter_DPD(void)
1195          {
1196   1              //P17
1197   1              P30_init();
1198   1              exti1_init();
1199   1              
1200   1              set_PD;
1201   1              
1202   1              PICON  = PICON & 0xFE;
1203   1                                      
1204   1              clr_EX0;
1205   1              clr_EX1;
1206   1              clr_EPI;
1207   1      }
1208          
1209          void main_loop(void)
1210          {
1211   1              clr_EPI;
1212   1              OLED_Init();
1213   1              OLED_Clear();
1214   1              KeyInit();
1215   1              //read sys struct from ldrom
1216   1              getdata(SysStructLen,DATA_START_ADDR,(unsigned char *)&sysinfo);
1217   1              stage_loopcnt = 0;
1218   1              sysinfo.isneedinitstage = 1;
1219   1              powercnt = 0;
1220   1              isdisplaybaticon = 0;
1221   1              batlevel = 0xff;
1222   1              val = 0;
1223   1              initADC();      
1224   1              while(!GETKEY);
1225   1              while(1)
1226   1              {
1227   2                      KeyScan();
1228   2                      
1229   2                      if ((sysinfo.isinitsys != 0xA5)||(sysinfo.sysloop == SYSINIT))
1230   2                      {
1231   3                              //clr sysinfo
1232   3                              sysinfo.language = CHINESE;
C51 COMPILER V9.54   COUNT                                                                 03/13/2019 21:07:10 PAGE 21  

1233   3                              sysinfo.numtype = ARABNUM;
1234   3                              sysinfo.totalcnt = 0;
1235   3                              sysinfo.isinitsys = 0xA5;
1236   3                              sysinfo.sysloop = SELECT_LANGUAGE;
1237   3      //                      sysinfo.lastpower = 0xFF;
1238   3      //                      batlevel = 0xff;
1239   3                              //Display power on stage
1240   3                              OLED_Set_Pos(7,1);
1241   3                              Draw_BMP(12,1,12+8,3,font_A_Z + ('K' - 'A')*16);
1242   3                              Draw_BMP(20,1,20+16,3,font_CHN + (SAN)*32);
1243   3                              Draw_BMP(36,1,36+8,3,font_A_Z + ('W' - 'A')*16);
1244   3                              Draw_BMP(44,1,44+8,3,font_A_Z + ('A' - 'A')*16);
1245   3                              
1246   3                              powercnt = 0;
1247   3                              Erase_LDROM(512,0);
1248   3                              Erase_LDROM(512,512);   
1249   3      //                      initADC();
1250   3      //                      sysinfo.lastpower = getbatlever(P30);
1251   3                              while(powercnt<400);
1252   3                              powercnt=0;
1253   3                              sysinfo.isneedinitstage = 1;
1254   3                              
1255   3                              OLED_CLS_Windows(12,1,52,3);
1256   3                      }
1257   2                      SysLoop();
1258   2      
1259   2                      if (get_battery_time >= 200)
1260   2                      {
1261   3                              if (EADC == 0)
1262   3                                      set_EADC;
1263   3                              get_battery_time = 0;
1264   3                      }
1265   2                      //power mode
1266   2                      if (powercnt >= POWER_CNT1)
1267   2                      {
1268   3                              
1269   3                              //close OLED
1270   3                              OLED_Display_Off();
1271   3                              //OLED power down
1272   3                              //save DATA 
1273   3                              if ((sysinfo.sysloop == RST_CNT) ||(sysinfo.sysloop == RST_SYS))
1274   3                                      sysinfo.sysloop = CNT_STAGE;
1275   3                              savedata(SysStructLen,DATA_START_ADDR,(unsigned char *)&sysinfo);
1276   3      
1277   3                              Set_All_GPIO_Quasi_Mode;
1278   3                              clr_ADCEN;
1279   3                              clr_TR0;
1280   3                              
1281   3                              P14_OpenDrain_Mode;
1282   3                              P14 = 0;
1283   3                              Enter_DPD();
1284   3                              powercnt = 0;
1285   3                              set_TR0;
1286   3                              initADC();
1287   3                              return;
1288   3                      }
1289   2              }
1290   1      }
1291          
1292          


C51 COMPILER V9.54   COUNT                                                                 03/13/2019 21:07:10 PAGE 22  

MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   4583    ----
   CONSTANT SIZE    =     42    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     60      77
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      2    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
