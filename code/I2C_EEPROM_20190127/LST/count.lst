C51 COMPILER V9.54   COUNT                                                                 02/22/2019 20:34:36 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE COUNT
OBJECT MODULE PLACED IN .\Output\count.obj
COMPILER INVOKED BY: D:\keil\C51\BIN\C51.EXE Code\count.c ROM(COMPACT) OPTIMIZE(8,SIZE) BROWSE INCDIR(..\..\Include;..\I
                    -nclude) DEFINE(FOSC_160000) DEBUG OBJECTEXTEND PRINT(.\LST\count.lst) OBJECT(.\Output\count.obj)

line level    source

   1          #include "N76E003.h"
   2          #include "SFR_Macro.h"
   3          #include "count.h"
   4          #include "fontdata.h"
   5          #include "Function_define.h"
   6          #include "OLED.h"
   7          #include "dataflash.h"
   8          #include "ds1302.h"
   9          extern void Timer0_Init(void);
  10          extern void Timer1_Delay10ms(unsigned long cnt);
  11          extern void initADC(void);
  12          extern void Erase_LDROM(unsigned int datasize,unsigned int dataaddr);
  13          #define POWER_WAKEUP    1
  14          #if POWER_WAKEUP
  15          #define KEYINPUTMODE    P17_Input_Mode;P30_Input_Mode;P04_Input_Mode
  16          #else
              #define KEYINPUTMODE    P17_Input_Mode
              #endif
  19          #define GETKEY          P17
  20          
  21          unsigned char stage_loopcnt = 0;
  22          
  23          SysStruct       sysinfo;
  24          KEYTYPE keytype;
  25          unsigned char curKey,preKey;
  26          unsigned char debounce;
  27          unsigned char islongpress;
  28          unsigned char is_5ms_Flag;
  29          unsigned char blinktime;
  30          unsigned int powercnt;
  31          
  32          #if POWER_WAKEUP
  33          unsigned char power_debounce;
  34          bit  is_enter_charging;
  35          unsigned char las_stage;
  36          #endif
  37          #define BAT_LEVEL_BUF_0 0x840
  38          #define BAT_LEVEL_BUF_1 0x8A0
  39          #define BAT_LEVEL_BUF_2 0x900
  40          #define BAT_LEVEL_BUF_3 0x960
  41          
  42          unsigned int adcvalue[16];
  43          unsigned char adc_cnt;
  44          unsigned char batlevel=0xFF;
  45          bit isdisplaybaticon = 0;
  46          extern bit BIT_TMP;
  47          
  48          unsigned char ischangebatlevel_cnt = 0;
  49          unsigned char get_battery_time = 0;
  50          unsigned int val = 0;
  51          
  52          void KeyInit(void)
  53          {
  54   1              curKey = 0;
C51 COMPILER V9.54   COUNT                                                                 02/22/2019 20:34:36 PAGE 2   

  55   1              preKey = 1;
  56   1              debounce = 0;
  57   1              islongpress = 0;
  58   1              keytype = 0;
  59   1              KEYINPUTMODE;
  60   1              
  61   1              //
  62   1              #if POWER_WAKEUP
  63   1              power_debounce = 0;
  64   1              is_enter_charging = 0;
  65   1              #endif
  66   1      }
  67          
  68          void KeyScan(void)
  69          {
  70   1              if (is_5ms_Flag)
  71   1              {
  72   2                      is_5ms_Flag = 0;
  73   2                      curKey = GETKEY;
  74   2                      if (curKey != preKey)
  75   2                      {
  76   3                              preKey = curKey;
  77   3                              if ((islongpress == 0)&&(debounce > 10))
  78   3                              {
  79   4                                      keytype = SHORTKEY;
  80   4                              }
  81   3                              else if (islongpress >= 10)
  82   3                              {
  83   4                                      keytype = LONGKEY_12S;
  84   4                              }
  85   3                              else if (islongpress >= 3)
  86   3                              {
  87   4                                      keytype = LONGKEY_5S;
  88   4                              }
  89   3                              else if (islongpress >= 2)
  90   3                              {
  91   4                                      keytype = LONGKEY_2S;
  92   4                              }
  93   3                              debounce = 0;
  94   3                              islongpress = 0;
  95   3                              
  96   3                              powercnt = 0;
  97   3                      }
  98   2                      else if(curKey == 0)
  99   2                      {
 100   3                              debounce++;
 101   3                              if (debounce > 200)
 102   3                              {
 103   4                                      debounce = 0;
 104   4                                      islongpress++;
 105   4                              }
 106   3                              powercnt = 0;
 107   3                      }
 108   2                      #if POWER_WAKEUP
 109   2                      //5v power check
 110   2                      if (P30 == 0)
 111   2                      {
 112   3                              power_debounce = 0;
 113   3                              if (is_enter_charging == 1)
 114   3                              {
 115   4                                      is_enter_charging = 0;
 116   4                                      sysinfo.sysloop = las_stage;
C51 COMPILER V9.54   COUNT                                                                 02/22/2019 20:34:36 PAGE 3   

 117   4                                      sysinfo.isneedinitstage = 1;
 118   4                                      OLED_CLS_Windows(16,1,48,3);
 119   4                              }
 120   3                      }
 121   2                      else
 122   2                      {
 123   3                              powercnt = 0;
 124   3                              power_debounce++;
 125   3                              if (power_debounce > 10)
 126   3                              {
 127   4                                      //enter power charging
 128   4                                      power_debounce = 10;
 129   4                                      if (is_enter_charging == 0)
 130   4                                      {
 131   5                                              is_enter_charging = 1;
 132   5                                              las_stage = sysinfo.sysloop;
 133   5                                              sysinfo.sysloop = SYS_CHARGE;
 134   5                                              sysinfo.isneedinitstage = 1;
 135   5                                      }
 136   4                              }
 137   3                      }
 138   2                      #endif
 139   2              }
 140   1      }
 141          
 142          void display_Language_chinese(unsigned char isdisplay)
 143          {
 144   1              if (isdisplay == 1)
 145   1              {
 146   2                      Draw_BMP(16,0,16+16,2,(unsigned char *)(font_CHN + (ZHONG)*32));
 147   2                      Draw_BMP(32,0,32+16,2,font_CHN + (WEN)*32);
 148   2              }
 149   1              else
 150   1              {
 151   2                      OLED_CLS_Windows(16,0,48,2);
 152   2              }
 153   1      }
 154          void display_Language_english(unsigned char isdisplay)
 155          {
 156   1              char * en = "ENGLISH";
 157   1              char i;
 158   1              if (isdisplay == 1)
 159   1              {
 160   2                      for(i=0;i<7;i++)
 161   2                              Draw_BMP(4+8*i,2,4+8+8*i,4,font_A_Z + (en[i] - 'A')*16);
 162   2              }
 163   1              else
 164   1              {
 165   2                      OLED_CLS_Windows(4,2,60,4);
 166   2              }
 167   1      }
 168          void Select_Language(void)
 169          {
 170   1              if (sysinfo.isneedinitstage == 1)
 171   1              {
 172   2                      sysinfo.isneedinitstage = 0;
 173   2                      //init 
 174   2                      OLED_CLS_Windows(12,1,52,3);
 175   2                      display_Language_chinese(1);
 176   2                      display_Language_english(1);            
 177   2                      stage_loopcnt = sysinfo.language;
 178   2                      blinktime = (BLINK_H+BLINK_L);
C51 COMPILER V9.54   COUNT                                                                 02/22/2019 20:34:36 PAGE 4   

 179   2              }
 180   1              if (keytype != NULLKEY)
 181   1              {
 182   2                      if (keytype == SHORTKEY)
 183   2                      {
 184   3                              if (stage_loopcnt == CHINESE)
 185   3                              {
 186   4                                      display_Language_chinese(1);
 187   4                                      stage_loopcnt = ENGLISH;
 188   4                              }
 189   3                              else
 190   3                              {
 191   4                                      display_Language_english(1);
 192   4                                      stage_loopcnt = CHINESE;        
 193   4                              }
 194   3                              sysinfo.language = stage_loopcnt;
 195   3                      }
 196   2                      else if (keytype >= LONGKEY_2S)
 197   2                      {
 198   3                              sysinfo.language = stage_loopcnt;
 199   3                              sysinfo.sysloop = SELECT_NUMTYPE;
 200   3                              stage_loopcnt = 0;
 201   3                              blinktime = 0;
 202   3                              sysinfo.isneedinitstage = 1;
 203   3                              display_Language_english(0);
 204   3                              display_Language_chinese(0);
 205   3                      }
 206   2                      keytype = NULLKEY;
 207   2              }
 208   1              //blink
 209   1              if (blinktime == BLINK_H)
 210   1              {
 211   2                      if (sysinfo.language == CHINESE)
 212   2                              display_Language_chinese(0);
 213   2                      else
 214   2                              display_Language_english(0);
 215   2              }       
 216   1              else if (blinktime == (BLINK_H+BLINK_L))
 217   1              {
 218   2                      if (sysinfo.language == CHINESE)
 219   2                              display_Language_chinese(1);
 220   2                      else
 221   2                              display_Language_english(1);            
 222   2              }
 223   1      }
 224          
 225          
 226          unsigned int getdiv(unsigned long x,unsigned long y)
 227          {
 228   1              unsigned int div = 0;
 229   1              while(x >= y)
 230   1              {
 231   2                      div++;
 232   2                      x = x - y;
 233   2              }
 234   1              return div;
 235   1      }
 236          unsigned int getremainder(unsigned long x,unsigned long y)
 237          {
 238   1              while(x >= y)
 239   1              {
 240   2                      x = x - y;
C51 COMPILER V9.54   COUNT                                                                 02/22/2019 20:34:36 PAGE 5   

 241   2              }
 242   1              return x;
 243   1      }
 244          
 245          void display_cnt_stage_arabnum(unsigned char isdisplay)
 246          {
 247   1              char * nor = "NORMAL";
 248   1              char i;
 249   1              if (sysinfo.language == ENGLISH)
 250   1              {
 251   2                      if (isdisplay == 1)
 252   2                      {
 253   3                              for (i=0;i<6;i++)
 254   3                              {
 255   4                                      Draw_BMP(8 + i*8,0,8+8 + i*8,2,font_A_Z + (nor[i] - 'A')*16);
 256   4                              }
 257   3                      }
 258   2                      else
 259   2                      {
 260   3                              OLED_CLS_Windows(8,0,56,2);
 261   3                      }               
 262   2              }
 263   1              else
 264   1              {
 265   2                      if (isdisplay == 1)
 266   2                      {
 267   3                              Draw_BMP(16,0,16+16,2,font_CHN + (SHU)*32);
 268   3                              Draw_BMP(32,0,32+16,2,font_CHN + (ZI)*32);
 269   3                      }
 270   2                      else
 271   2                      {
 272   3                              OLED_CLS_Windows(16,0,48,2);
 273   3                      }
 274   2              }
 275   1      }
 276          void display_cnt_stage_tibnum(unsigned char isdisplay)
 277          {       
 278   1              char * nor = "TIBETAN";
 279   1              char i;
 280   1              if (sysinfo.language == ENGLISH)
 281   1              {
 282   2                      if (isdisplay == 1)
 283   2                      {
 284   3                              for (i=0;i<7;i++)
 285   3                              {
 286   4                                      Draw_BMP(4+ i*8,2,8+4+ i*8,4,font_A_Z + (nor[i] - 'A')*16);
 287   4                              }
 288   3                      }
 289   2                      else
 290   2                      {
 291   3                              OLED_CLS_Windows(4,2,60,4);
 292   3                      }               
 293   2              }
 294   1              else
 295   1              {
 296   2                      if (isdisplay == 1)
 297   2                      {
 298   3                              Draw_BMP(0,2,0+16,4,font_CHN + (ZANG)*32);
 299   3                              Draw_BMP(16,2,16+16,4,font_CHN + (WEN)*32);             
 300   3                              Draw_BMP(32,2,16+32,4,font_CHN + (SHU)*32);
 301   3                              Draw_BMP(48,2,48+16,4,font_CHN + (ZI)*32);
 302   3                      }
C51 COMPILER V9.54   COUNT                                                                 02/22/2019 20:34:36 PAGE 6   

 303   2                      else
 304   2                      {
 305   3                              OLED_CLS_Windows(0,2,64,4);
 306   3                      }
 307   2              }
 308   1      }
 309          void Select_NumType(void)
 310          {
 311   1              if (sysinfo.isneedinitstage == 1)
 312   1              {
 313   2                      sysinfo.isneedinitstage = 0;
 314   2                      display_cnt_stage_arabnum(1);
 315   2                      display_cnt_stage_tibnum(1);
 316   2                      stage_loopcnt = sysinfo.numtype;
 317   2                      blinktime = (BLINK_H+BLINK_L);
 318   2              }       
 319   1              if (keytype != NULLKEY)
 320   1              {
 321   2                      if (keytype == SHORTKEY)
 322   2                      {
 323   3                              if (stage_loopcnt == TIBENUM)
 324   3                              {
 325   4                                      display_cnt_stage_tibnum(1);
 326   4                                      stage_loopcnt = ARABNUM;
 327   4                              }
 328   3                              else
 329   3                              {
 330   4                                      display_cnt_stage_arabnum(1);
 331   4                                      stage_loopcnt = TIBENUM;
 332   4                              }
 333   3                              sysinfo.numtype = stage_loopcnt;
 334   3                      }
 335   2                      else if (keytype >= LONGKEY_2S)
 336   2                      {
 337   3                              sysinfo.sysloop = CNT_STAGE;
 338   3                              sysinfo.numtype = stage_loopcnt;
 339   3                              stage_loopcnt = 0;
 340   3                              blinktime = 0;
 341   3                              sysinfo.isneedinitstage = 1;
 342   3                              display_cnt_stage_arabnum(0);
 343   3                              display_cnt_stage_tibnum(0);                    
 344   3                      }
 345   2                      keytype = NULLKEY;
 346   2              }
 347   1              //blink
 348   1              if (blinktime == BLINK_H)
 349   1              {
 350   2                      if (stage_loopcnt == TIBENUM)
 351   2                              display_cnt_stage_tibnum(0);
 352   2                      else if (stage_loopcnt == ARABNUM)
 353   2                              display_cnt_stage_arabnum(0);
 354   2              }       
 355   1              else if (blinktime == (BLINK_H+BLINK_L))
 356   1              {
 357   2                      if (stage_loopcnt == TIBENUM)
 358   2                              display_cnt_stage_tibnum(1);
 359   2                      else if (stage_loopcnt == ARABNUM)
 360   2                              display_cnt_stage_arabnum(1);
 361   2              }       
 362   1      }
 363          void display_cnt_stage_cnt(unsigned long cnt,unsigned char isdisplay)
 364          {
C51 COMPILER V9.54   COUNT                                                                 02/22/2019 20:34:36 PAGE 7   

 365   1              
 366   1              unsigned char i;
 367   1              unsigned long temp;
 368   1              unsigned char nextdisplay=0; 
 369   1              unsigned char start_index=0;
 370   1              if (isdisplay == 0)
 371   1              {
 372   2                      OLED_CLS_Windows(0,2,64,4);
 373   2                      return;
 374   2              }
 375   1              temp = cnt;
 376   1              if (sysinfo.numtype == ARABNUM)
 377   1              {
 378   2                      
 379   2                      #define CNT_START_ARABNUM       12
 380   2                      #define ARABNUM_SIZE    8
 381   2                      start_index = CNT_START_ARABNUM;
 382   2                      i = getdiv(temp,10000);
 383   2                      temp = getremainder(temp,10000);
 384   2                      if (i != 0)
 385   2                      {
 386   3                              Draw_BMP(start_index,2,start_index+ARABNUM_SIZE,4,font2_0_9 + 16*i);
 387   3                              nextdisplay = 1;
 388   3                              start_index+=ARABNUM_SIZE;
 389   3                      }
 390   2                      else
 391   2                      {
 392   3                              start_index+=ARABNUM_SIZE>>1;
 393   3                      }
 394   2                      
 395   2                      i = getdiv(temp,1000);
 396   2                      temp = getremainder(temp,1000);
 397   2                      if ((nextdisplay == 1)||(i != 0))
 398   2                      {
 399   3                              nextdisplay = 1;
 400   3                              Draw_BMP(start_index,2,start_index+ARABNUM_SIZE,4,font2_0_9 + 16*i);
 401   3                              start_index+=ARABNUM_SIZE;
 402   3                      }
 403   2                      else
 404   2                      {
 405   3                              start_index+=ARABNUM_SIZE>>1;
 406   3                      }
 407   2                      
 408   2                      i = getdiv(temp,100);
 409   2                      temp = getremainder(temp,100);
 410   2                      if ((nextdisplay == 1)||(i != 0))
 411   2                      {
 412   3                              nextdisplay = 1;
 413   3                              Draw_BMP(start_index,2,start_index+ARABNUM_SIZE,4,font2_0_9 + 16*i);
 414   3                              start_index+=ARABNUM_SIZE;
 415   3                      }
 416   2                      else
 417   2                      {
 418   3                              start_index+=ARABNUM_SIZE>>1;
 419   3                      }
 420   2                      
 421   2                      i = getdiv(temp,10);
 422   2                      temp = getremainder(temp,10);
 423   2                      if ((nextdisplay == 1)||(i != 0))
 424   2                      {
 425   3                              nextdisplay = 1;
 426   3                              Draw_BMP(start_index,2,start_index+ARABNUM_SIZE,4,font2_0_9 + 16*i);
C51 COMPILER V9.54   COUNT                                                                 02/22/2019 20:34:36 PAGE 8   

 427   3                              start_index+=ARABNUM_SIZE;
 428   3                      }
 429   2                      else
 430   2                      {
 431   3                              start_index+=ARABNUM_SIZE>>1;
 432   3                      }
 433   2                      
 434   2                      i = temp;
 435   2                      Draw_BMP(start_index,2,start_index+ARABNUM_SIZE,4,font2_0_9 + 16*i);
 436   2              }
 437   1              else
 438   1              {
 439   2                      #define CNT_START_TIBENUM       2
 440   2                      #define TIBENUM_SIZE    12
 441   2                      start_index = CNT_START_TIBENUM;
 442   2                      i = getdiv(temp,10000);
 443   2                      temp = getremainder(temp,10000);
 444   2                      if (i != 0)
 445   2                      {
 446   3                              Draw_BMP(start_index,2,start_index+TIBENUM_SIZE,4,t0 + 24*i);
 447   3                              nextdisplay = 1;
 448   3                              start_index+=TIBENUM_SIZE;
 449   3                      }
 450   2                      else
 451   2                              start_index+=TIBENUM_SIZE>>1;
 452   2                      
 453   2                      i = getdiv(temp,1000);
 454   2                      temp = getremainder(temp,1000);
 455   2                      if ((nextdisplay == 1)||(i != 0))
 456   2                      {
 457   3                              Draw_BMP(start_index,2,start_index+TIBENUM_SIZE,4,t0 + 24*i);
 458   3                              nextdisplay = 1;
 459   3                              start_index+=TIBENUM_SIZE;
 460   3                      }
 461   2                      else
 462   2                              start_index+=TIBENUM_SIZE>>1;
 463   2                      
 464   2                      i = getdiv(temp,100);
 465   2                      temp = getremainder(temp,100);
 466   2                      if ((nextdisplay == 1)||(i != 0))
 467   2                      {
 468   3                              Draw_BMP(start_index,2,start_index+TIBENUM_SIZE,4,t0 + 24*i);
 469   3                              nextdisplay = 1;
 470   3                              start_index+=TIBENUM_SIZE;
 471   3                      }
 472   2                      else
 473   2                              start_index+=TIBENUM_SIZE>>1;
 474   2                      
 475   2                      i = getdiv(temp,10);
 476   2                      temp = getremainder(temp,10);
 477   2                      if ((nextdisplay == 1)||(i != 0))
 478   2                      {
 479   3                              Draw_BMP(start_index,2,start_index+TIBENUM_SIZE,4,t0 + 24*i);
 480   3                              nextdisplay = 1;
 481   3                              start_index+=TIBENUM_SIZE;
 482   3                      }
 483   2                      else
 484   2                              start_index+=TIBENUM_SIZE>>1;
 485   2                      
 486   2                      i = temp;
 487   2                      Draw_BMP(start_index,2,start_index+TIBENUM_SIZE,4,t0 + 24*i);   
 488   2              }
C51 COMPILER V9.54   COUNT                                                                 02/22/2019 20:34:36 PAGE 9   

 489   1      }
 490          
 491          
 492          
 493          unsigned char getbatlever(unsigned char ischarging)
 494          {
 495   1              unsigned char i,j;
 496   1              unsigned int curval = 0;
 497   1              unsigned char temp=0xFF;
 498   1              if (adc_cnt >= 16)
 499   1              {
 500   2                      clr_EADC;
 501   2                      adc_cnt = 0;
 502   2                      for(i=0;i<16;i++)
 503   2                      {
 504   3                              for (j = i+1;j<16;j++)
 505   3                              {
 506   4                                      curval = adcvalue[j];
 507   4                                      if (curval > adcvalue[i])
 508   4                                      {
 509   5                                              adcvalue[j] = adcvalue[i];
 510   5                                              adcvalue[i] = curval;
 511   5                                      }
 512   4                              }
 513   3                      }
 514   2                      curval = 0;
 515   2                      for (i = 4; i<16;i++)
 516   2                              curval+=adcvalue[i];
 517   2                      curval = curval>>3;
 518   2                      if (ischarging == 1)
 519   2                              curval -= 0x20;
 520   2                      
 521   2                      
 522   2                      if (val == 0)
 523   2                              val = curval;
 524   2                      else
 525   2                      {                       
 526   3                              if (curval > (val+5))
 527   3                              {
 528   4                                      val++;
 529   4                                      return 0xFF;
 530   4                                      //curval = val+5;
 531   4                              }
 532   3                              else if ((curval+5) < val)
 533   3                              {
 534   4                                      val--;
 535   4                                      return 0xFF;
 536   4                                      //curval = val-5;
 537   4                              }
 538   3      //                      curval = curval >> 1;
 539   3      //                      val = val >> 1;
 540   3                              curval = (curval +val) >> 1;
 541   3                              if (ischarging == 1)
 542   3                              {                               
 543   4                                      if (curval > val)
 544   4                                      {
 545   5                                              val = curval;
 546   5      //                                      val = val << 1;
 547   5                                      }
 548   4                              }
 549   3                              else
 550   3                              {
C51 COMPILER V9.54   COUNT                                                                 02/22/2019 20:34:36 PAGE 10  

 551   4                                      if (val > curval)
 552   4                                      {
 553   5                                              val = curval;
 554   5      //                                      val = val << 1;
 555   5                                      }
 556   4                              }
 557   3                              
 558   3                      }
 559   2                      
 560   2                      
 561   2                      if (isdisplaybaticon == 0)
 562   2                      {
 563   3                              if (val > BAT_LEVEL_BUF_3)
 564   3                                      temp =  4;
 565   3                              else if (val > BAT_LEVEL_BUF_2)
 566   3                                      temp =  3;
 567   3                              else if (val > BAT_LEVEL_BUF_1)
 568   3                                      temp =  2;
 569   3                              else if (val > BAT_LEVEL_BUF_0)
 570   3                                      temp =  1;
 571   3                              else 
 572   3                                      temp =  0;
 573   3                              ischangebatlevel_cnt = 0;
 574   3      //                      set_EADC;
 575   3                      }
 576   2                      else
 577   2                      {
 578   3                              if (val < (BAT_LEVEL_BUF_0 - 0x08))
 579   3                                      temp =  0;
 580   3                              else if ((val > (BAT_LEVEL_BUF_0 + 0x08))&&(val < (BAT_LEVEL_BUF_1 - 0x08)))
 581   3                              {
 582   4                                      temp =  1;
 583   4                              }
 584   3                              else if ((val > (BAT_LEVEL_BUF_1+ 0x08))&&(val < (BAT_LEVEL_BUF_2 - 0x08)))
 585   3                              {
 586   4                                      temp =  2;
 587   4                              }
 588   3                              else if ((val > (BAT_LEVEL_BUF_2 + 0x08))&&(val < (BAT_LEVEL_BUF_3 - 0x08)))
 589   3                              {
 590   4                                      temp =  3;
 591   4                              }
 592   3                              else if (val > (BAT_LEVEL_BUF_3 + 0x08))
 593   3                              {
 594   4                                      temp =  4;
 595   4                              }
 596   3                              
 597   3                              if (temp != batlevel)
 598   3                              {
 599   4                                      ischangebatlevel_cnt++;
 600   4                                      if (ischangebatlevel_cnt < 5)
 601   4                                      {
 602   5                                              temp = batlevel;
 603   5                                      }
 604   4                                      else
 605   4                                      {
 606   5                                              ischangebatlevel_cnt = 0;
 607   5                                              if (ischarging == 1)
 608   5                                              {
 609   6                                                      if (temp <= batlevel)
 610   6                                                              temp = batlevel;
 611   6                                              }
 612   5                                              else
C51 COMPILER V9.54   COUNT                                                                 02/22/2019 20:34:36 PAGE 11  

 613   5                                              {
 614   6                                                      if (temp >= batlevel)
 615   6                                                              temp = batlevel;
 616   6                                              }
 617   5                                      }
 618   4                              }
 619   3                              else
 620   3                                      ischangebatlevel_cnt = 0;
 621   3                      }
 622   2      //              set_EADC;
 623   2              }
 624   1              return temp;
 625   1      }
 626          
 627          void display_baticonlevel(unsigned char level)
 628          {
 629   1              unsigned char *buf;
 630   1      //      if (level == 0)
 631   1      //      {
 632   1      //              for (i = 0; i < 8;i++)
 633   1      //              {
 634   1      //                      baticon[4+i] = 0x18;
 635   1      //                      baticon[20+i] = 0x0C;
 636   1      //              }
 637   1      //      }
 638   1      //      else if(level == 1)
 639   1      //      {
 640   1      //              for (i = 0; i < 2;i++)
 641   1      //              {
 642   1      //                      baticon[4+i] = 0xF8;
 643   1      //                      baticon[20+i] = 0x0F;
 644   1      //              }
 645   1      //              for (i = 2; i < 8;i++)
 646   1      //              {
 647   1      //                      baticon[4+i] = 0x18;
 648   1      //                      baticon[20+i] = 0x0C;
 649   1      //              }
 650   1      //      }
 651   1      //      else if(level == 2)
 652   1      //      {
 653   1      //              for (i = 0; i < 4;i++)
 654   1      //              {
 655   1      //                      baticon[4+i] = 0xF8;
 656   1      //                      baticon[20+i] = 0x0F;
 657   1      //              }
 658   1      //              for (i = 4; i < 8;i++)
 659   1      //              {
 660   1      //                      baticon[4+i] = 0x18;
 661   1      //                      baticon[20+i] = 0x0C;
 662   1      //              }
 663   1      //      }
 664   1      //      else if(level == 3)
 665   1      //      {
 666   1      //              for (i = 0; i < 6;i++)
 667   1      //              {
 668   1      //                      baticon[4+i] = 0xF8;
 669   1      //                      baticon[20+i] = 0x0F;
 670   1      //              }
 671   1      //              for (i = 6; i < 8;i++)
 672   1      //              {
 673   1      //                      baticon[4+i] = 0x18;
 674   1      //                      baticon[20+i] = 0x0C;
C51 COMPILER V9.54   COUNT                                                                 02/22/2019 20:34:36 PAGE 12  

 675   1      //              }
 676   1      //      }
 677   1      //      else
 678   1      //      {
 679   1      //              for (i = 0; i < 8;i++)
 680   1      //              {
 681   1      //                      baticon[4+i] = 0xF8;
 682   1      //                      baticon[20+i] = 0x0F;
 683   1      //              }
 684   1      //      }
 685   1              buf = (unsigned char *)baticon + (level * 32);
 686   1              isdisplaybaticon = 1;
 687   1              Draw_BMP(0,0,16,2,baticon);
 688   1      }
 689          
 690          void display_baticon(void)
 691          {
 692   1              unsigned char level;
 693   1              level = getbatlever(0);
 694   1              if (level != 0xFF)
 695   1              {
 696   2                      if (batlevel != level)
 697   2                      {
 698   3                              batlevel = level;
 699   3                              display_baticonlevel(batlevel);
 700   3                      }
 701   2                      sysinfo.lastpower = level;
 702   2                      adc_cnt = 0;
 703   2      //              set_EADC;
 704   2              }
 705   1      }
 706          
 707          void Cnt_Stage(void)
 708          {               
 709   1              if (sysinfo.isneedinitstage == 1)
 710   1              {
 711   2                      sysinfo.isneedinitstage = 0;
 712   2                      blinktime = 0;
 713   2                      isdisplaybaticon = 0;           
 714   2      //              display_cnt_stage_date(1);
 715   2                      initADC();
 716   2                      display_cnt_stage_cnt(sysinfo.totalcnt,1);
 717   2                      if (sysinfo.lastpower == 0xFF)
 718   2                      {
 719   3                              isdisplaybaticon = 0;
 720   3                              sysinfo.lastpower = getbatlever(0);                     
 721   3                      }
 722   2                      batlevel = sysinfo.lastpower;
 723   2                      display_baticonlevel(sysinfo.lastpower);
 724   2                      
 725   2              }
 726   1      
 727   1              display_baticon();
 728   1      
 729   1      //      if (powercnt == 20)
 730   1      //      {
 731   1      //              powercnt = 0;
 732   1      //              sysinfo.totalcnt++;
 733   1      //              if (sysinfo.totalcnt > 99999)
 734   1      //                              sysinfo.totalcnt = 0;
 735   1      //              display_cnt_stage_cnt(sysinfo.totalcnt,1);
 736   1      //      }
C51 COMPILER V9.54   COUNT                                                                 02/22/2019 20:34:36 PAGE 13  

 737   1              
 738   1              if (keytype != NULLKEY)
 739   1              {
 740   2      //              sysinfo.totalcnt = val;
 741   2      //              display_cnt_stage_cnt(sysinfo.totalcnt,1);
 742   2                      if (keytype == SHORTKEY)
 743   2                      {
 744   3                              sysinfo.totalcnt++;
 745   3                              if (sysinfo.totalcnt > 99999)
 746   3                              {
 747   4                                      sysinfo.totalcnt = 0;
 748   4                                      display_cnt_stage_cnt(0,0);     
 749   4                              }
 750   3                              display_cnt_stage_cnt(sysinfo.totalcnt,1);
 751   3                      }
 752   2                      else if (keytype == LONGKEY_5S)
 753   2                      {
 754   3                              sysinfo.sysloop = RST_CNT;
 755   3                              sysinfo.isneedinitstage = 1;
 756   3                              stage_loopcnt = 0;
 757   3                              batlevel = 0xFF;
 758   3                              OLED_CLS_Windows(0,0,64,2);
 759   3      //                      display_cnt_stage_date(0);
 760   3                              display_cnt_stage_cnt(0,0);                     
 761   3                      }
 762   2                      else if (keytype == LONGKEY_12S)
 763   2                      {
 764   3                              sysinfo.sysloop = RST_SYS;
 765   3                              sysinfo.isneedinitstage = 1;
 766   3                              stage_loopcnt = 0;
 767   3                              batlevel = 0xFF;
 768   3                              OLED_CLS_Windows(0,0,64,2);
 769   3      //                      display_cnt_stage_date(0);
 770   3                              display_cnt_stage_cnt(0,0);                     
 771   3                      }
 772   2                      keytype = NULLKEY;
 773   2              }
 774   1      }
 775          
 776          
 777          void display_rst_cnt_stage_1(unsigned char isdisplay)
 778          {
 779   1              char i;
 780   1              char * en = "RST";
 781   1              char * en1 = "CNT";
 782   1              if (sysinfo.language == ENGLISH)
 783   1              {
 784   2                      if (isdisplay == 1)
 785   2                      {
 786   3                              for (i=0;i<3;i++)
 787   3                              {
 788   4                                      Draw_BMP(6+i*8,0,8+6 + i*8,2,font_A_Z + (en[i]-'A')*16);
 789   4                                      Draw_BMP(32+ i*8,0,8+32+ i*8,2,font_A_Z + (en1[i]-'A')*16);
 790   4                              }
 791   3                      }
 792   2                      else
 793   2                      {
 794   3                              OLED_CLS_Windows(6,0,56,2);
 795   3                      }               
 796   2              }
 797   1              else
 798   1              {
C51 COMPILER V9.54   COUNT                                                                 02/22/2019 20:34:36 PAGE 14  

 799   2                      if (isdisplay == 1)
 800   2                      {
 801   3                              Draw_BMP(16,0,16+16,2,font_CHN + (GUI)*32);
 802   3                              Draw_BMP(32,0,32+16,2,font_CHN + (LING)*32);
 803   3                      }
 804   2                      else
 805   2                      {
 806   3                              OLED_CLS_Windows(16,0,48,2);
 807   3                      }
 808   2              }
 809   1      }
 810          void display_rst_cnt_stage_yes(unsigned char isdisplay)
 811          {
 812   1              char i;
 813   1              char * en = "YES";
 814   1              if (sysinfo.language == ENGLISH)
 815   1              {
 816   2                      if (isdisplay == 1)
 817   2                      {
 818   3                              for (i=0;i<3;i++)
 819   3                              {
 820   4                                      Draw_BMP(10+i*8,2,8+10 + i*8,4,font_A_Z + (en[i]-'A')*16);
 821   4                              }
 822   3                      }
 823   2                      else
 824   2                      {
 825   3                              OLED_CLS_Windows(10,2,34,4);
 826   3                      }               
 827   2              }
 828   1              else    
 829   1              {
 830   2                      if (isdisplay == 1)
 831   2                      {
 832   3                              Draw_BMP(12,2,12+16,4,font_CHN + (SHI)*32);
 833   3                      }
 834   2                      else
 835   2                      {
 836   3                              OLED_CLS_Windows(12,2,28,4);
 837   3                      }       
 838   2              }
 839   1      }
 840          void display_rst_cnt_stage_no(unsigned char isdisplay)
 841          {
 842   1              char i;
 843   1              char * en = "NO";
 844   1              if (sysinfo.language == ENGLISH)
 845   1              {
 846   2                      if (isdisplay == 1)
 847   2                      {
 848   3                              for (i=0;i<2;i++)
 849   3                              {
 850   4                                      Draw_BMP(38+i*8,2,8+38 + i*8,4,font_A_Z + (en[i]-'A')*16);
 851   4                              }
 852   3                      }
 853   2                      else
 854   2                      {
 855   3                              OLED_CLS_Windows(38,2,54,4);
 856   3                      }               
 857   2              }
 858   1              else    
 859   1              {       
 860   2                      if (isdisplay == 1)
C51 COMPILER V9.54   COUNT                                                                 02/22/2019 20:34:36 PAGE 15  

 861   2                      {
 862   3                              Draw_BMP(36,2,36+16,4,font_CHN + (FOU)*32);
 863   3                      }
 864   2                      else
 865   2                      {
 866   3                              OLED_CLS_Windows(36,2,52,4);
 867   3                      }
 868   2              }       
 869   1      }
 870          void Rst_Cnt_Stage(void)
 871          {
 872   1              if (sysinfo.isneedinitstage == 1)
 873   1              {
 874   2                      sysinfo.isneedinitstage = 0;
 875   2                      display_rst_cnt_stage_1(1);
 876   2                      display_rst_cnt_stage_yes(1);
 877   2                      display_rst_cnt_stage_no(1);
 878   2                      blinktime = (BLINK_H+BLINK_L);
 879   2              }
 880   1              if (keytype != NULLKEY)
 881   1              {
 882   2                      if (keytype == SHORTKEY)
 883   2                      {
 884   3                              if (stage_loopcnt == YES)
 885   3                              {
 886   4                                      display_rst_cnt_stage_yes(1);
 887   4                                      stage_loopcnt = NO;
 888   4                              }
 889   3                              else
 890   3                              {
 891   4                                      stage_loopcnt = YES;
 892   4                                      display_rst_cnt_stage_no(1);
 893   4                              }
 894   3                      }
 895   2                      else if (keytype >= LONGKEY_2S)
 896   2                      {
 897   3                              if (stage_loopcnt == 0)//yes
 898   3                                      sysinfo.totalcnt = 0;
 899   3                              sysinfo.sysloop = CNT_STAGE;
 900   3                              stage_loopcnt = 0;
 901   3                              blinktime = 0;
 902   3                              batlevel = 0xff;
 903   3                              sysinfo.isneedinitstage = 1;
 904   3                              display_rst_cnt_stage_1(0);
 905   3                              display_rst_cnt_stage_yes(0);
 906   3                              display_rst_cnt_stage_no(0);                    
 907   3                      }
 908   2                      keytype = NULLKEY;
 909   2              }
 910   1              //blink
 911   1              if (blinktime == BLINK_H)
 912   1              {
 913   2                      if (stage_loopcnt == YES)
 914   2                              display_rst_cnt_stage_yes(0);
 915   2                      else if (stage_loopcnt == NO)
 916   2                              display_rst_cnt_stage_no(0);
 917   2              }       
 918   1              else if (blinktime == (BLINK_H+BLINK_L))
 919   1              {
 920   2                      if (stage_loopcnt == YES)
 921   2                              display_rst_cnt_stage_yes(1);
 922   2                      else if (stage_loopcnt == NO)
C51 COMPILER V9.54   COUNT                                                                 02/22/2019 20:34:36 PAGE 16  

 923   2                              display_rst_cnt_stage_no(1);
 924   2              }       
 925   1      }
 926          
 927          void display_rst_sys_stage_1(unsigned char isdisplay)
 928          {
 929   1              char i;
 930   1              char * en = "RST";
 931   1              char * en1 = "DEV";
 932   1              if (sysinfo.language == ENGLISH)
 933   1              {
 934   2                      if (isdisplay == 1)
 935   2                      {
 936   3                              for (i=0;i<3;i++)
 937   3                              {
 938   4                                      Draw_BMP(6+i*8,0,8+6 + i*8,2,font_A_Z + (en[i]-'A')*16);
 939   4                                      Draw_BMP(32+ i*8,0,8+32+ i*8,2,font_A_Z + (en1[i]-'A')*16);
 940   4                              }
 941   3                      }
 942   2                      else
 943   2                      {
 944   3                              OLED_CLS_Windows(6,0,56,2);
 945   3                      }               
 946   2              }
 947   1              else
 948   1              {       
 949   2                      if (isdisplay == 1)
 950   2                      {
 951   3                              Draw_BMP(16,0,16+16,2,font_CHN + (CHONG)*32);
 952   3                              Draw_BMP(32,0,32+16,2,font_CHN + (ZHI)*32);
 953   3                      }
 954   2                      else
 955   2                      {
 956   3                              OLED_CLS_Windows(16,0,48,2);
 957   3                      }
 958   2              }
 959   1      }
 960          
 961          void Rst_Sys_Stage(void)
 962          {
 963   1              if (sysinfo.isneedinitstage == 1)
 964   1              {
 965   2                      sysinfo.isneedinitstage = 0;
 966   2                      display_rst_sys_stage_1(1);
 967   2                      display_rst_cnt_stage_yes(1);
 968   2                      display_rst_cnt_stage_no(1);    
 969   2                      blinktime = (BLINK_H+BLINK_L);
 970   2              }
 971   1              if (keytype != NULLKEY)
 972   1              {
 973   2                      if (keytype == SHORTKEY)
 974   2                      {
 975   3                              if (stage_loopcnt == YES)
 976   3                              {
 977   4                                      display_rst_cnt_stage_yes(1);
 978   4                                      stage_loopcnt = NO;
 979   4                              }
 980   3                              else
 981   3                              {
 982   4                                      stage_loopcnt = YES;
 983   4                                      display_rst_cnt_stage_no(1);    
 984   4                              }
C51 COMPILER V9.54   COUNT                                                                 02/22/2019 20:34:36 PAGE 17  

 985   3                      }
 986   2                      else if (keytype >= LONGKEY_2S)
 987   2                      {
 988   3                              display_rst_sys_stage_1(0);
 989   3                              display_rst_cnt_stage_yes(0);   
 990   3                              display_rst_cnt_stage_no(0);    
 991   3                              if (stage_loopcnt == 0)
 992   3                              {
 993   4                                      sysinfo.sysloop = SYSINIT;
 994   4                              }
 995   3                              else
 996   3                                      sysinfo.sysloop = CNT_STAGE;
 997   3                              stage_loopcnt = 0;
 998   3                              sysinfo.isneedinitstage = 1;
 999   3                              batlevel = 0xff;
1000   3                      }
1001   2                      keytype = NULLKEY;
1002   2              }
1003   1              //blink
1004   1              if (blinktime == BLINK_H)
1005   1              {
1006   2                      if (stage_loopcnt == YES)
1007   2                              display_rst_cnt_stage_yes(0);
1008   2                      else if (stage_loopcnt == NO)
1009   2                              display_rst_cnt_stage_no(0);
1010   2              }       
1011   1              else if (blinktime == (BLINK_H+BLINK_L))
1012   1              {
1013   2                      if (stage_loopcnt == YES)
1014   2                              display_rst_cnt_stage_yes(1);
1015   2                      else if (stage_loopcnt == NO)
1016   2                              display_rst_cnt_stage_no(1);
1017   2              }               
1018   1      }
1019          
1020          #if POWER_WAKEUP
1021          void display_baticonlevel_charging(unsigned char level)
1022          {
1023   1              unsigned char *buf;
1024   1      //      if (level == 0)
1025   1      //      {
1026   1      //              for (i = 0; i < 24;i++)
1027   1      //              {
1028   1      //                      chargeicon[2+i] = 0x03;
1029   1      //                      chargeicon[34+i] = 0xC0;
1030   1      //              }
1031   1      //      }
1032   1      //      else if(level == 1)
1033   1      //      {
1034   1      //              for (i = 0; i < 6;i++)
1035   1      //              {
1036   1      //                      chargeicon[2+i] = 0xFF;
1037   1      //                      chargeicon[34+i] = 0xFF;
1038   1      //              }
1039   1      //              for (i = 6; i < 24;i++)
1040   1      //              {
1041   1      //                      chargeicon[2+i] = 0x03;
1042   1      //                      chargeicon[34+i] = 0xC0;
1043   1      //              }
1044   1      //      }
1045   1      //      else if(level == 2)
1046   1      //      {
C51 COMPILER V9.54   COUNT                                                                 02/22/2019 20:34:36 PAGE 18  

1047   1      //              for (i = 0; i < 12;i++)
1048   1      //              {
1049   1      //                      chargeicon[2+i] = 0xFF;
1050   1      //                      chargeicon[34+i] = 0xFF;
1051   1      //              }
1052   1      //              for (i = 12; i < 24;i++)
1053   1      //              {
1054   1      //                      chargeicon[2+i] = 0x03;
1055   1      //                      chargeicon[34+i] = 0xC0;
1056   1      //              }
1057   1      //      }
1058   1      //      else if(level == 3)
1059   1      //      {
1060   1      //              for (i = 0; i < 18;i++)
1061   1      //              {
1062   1      //                      chargeicon[2+i] = 0xFF;
1063   1      //                      chargeicon[34+i] = 0xFF;
1064   1      //              }
1065   1      //              for (i = 18; i < 24;i++)
1066   1      //              {
1067   1      //                      chargeicon[2+i] = 0x03;
1068   1      //                      chargeicon[34+i] = 0xC0;
1069   1      //              }
1070   1      //      }
1071   1      //      else
1072   1      //      {
1073   1      //              for (i = 0; i < 24;i++)
1074   1      //              {
1075   1      //                      chargeicon[2+i] = 0xFF;
1076   1      //                      chargeicon[34+i] = 0xFF;
1077   1      //              }
1078   1      //      }
1079   1              buf = (unsigned char*)chargeicon + (64*level);
1080   1              isdisplaybaticon = 1;
1081   1              Draw_BMP(16,1,16+32,3,buf);
1082   1      }
1083          
1084          
1085          void Sys_Charge_Stage(void)
1086          {
1087   1              unsigned char level;
1088   1              if (sysinfo.isneedinitstage == 1)
1089   1              {
1090   2                      sysinfo.isneedinitstage = 0;    
1091   2                      OLED_CLS_Windows(0,0,64,4);
1092   2                      initADC();              
1093   2                      if (sysinfo.lastpower == 0xFF)
1094   2                      {
1095   3                              isdisplaybaticon = 0;
1096   3                              sysinfo.lastpower = getbatlever(1);                     
1097   3                      }
1098   2                      batlevel = sysinfo.lastpower;
1099   2                      display_baticonlevel_charging(sysinfo.lastpower);
1100   2                      blinktime = 0;
1101   2              }
1102   1              if (keytype != NULLKEY)
1103   1              {
1104   2                      keytype = NULLKEY;
1105   2              }
1106   1              //blink
1107   1              if (blinktime == (BLINK_H+BLINK_L))
1108   1              {                       
C51 COMPILER V9.54   COUNT                                                                 02/22/2019 20:34:36 PAGE 19  

1109   2      //              level = getbatlever(1);
1110   2      //              sysinfo.totalcnt = val;
1111   2      //              display_cnt_stage_cnt(sysinfo.totalcnt,1);
1112   2                      level = getbatlever(1);
1113   2                      if (level != 0xFF)
1114   2                      {
1115   3                              if (batlevel != level)
1116   3                              {
1117   4                                      batlevel = level;
1118   4                                      //display bat
1119   4                                      display_baticonlevel_charging(batlevel);
1120   4                              }
1121   3                              sysinfo.lastpower = level;
1122   3                              adc_cnt = 0;                    
1123   3                      }
1124   2              }               
1125   1      }
1126          #endif
1127          void SysLoop(void)
1128          {
1129   1              switch(sysinfo.sysloop)
1130   1              {
1131   2                      case SELECT_LANGUAGE:
1132   2                              Select_Language();
1133   2                              break;
1134   2                      case SELECT_NUMTYPE:
1135   2                              Select_NumType();
1136   2                              break;
1137   2                      case CNT_STAGE:
1138   2                              Cnt_Stage();
1139   2                              break;
1140   2                      case RST_CNT:
1141   2                              Rst_Cnt_Stage();
1142   2                              break;
1143   2                      case RST_SYS:
1144   2                              Rst_Sys_Stage();
1145   2                              break;
1146   2                      #if POWER_WAKEUP
1147   2                      case SYS_CHARGE:
1148   2                              Sys_Charge_Stage();
1149   2                              break;
1150   2                      #endif
1151   2                      default:break;
1152   2              }
1153   1      }
1154          void PinInterrupt_ISR (void) interrupt 7
1155          {
1156   1              PIF = 0;
1157   1      }
1158          void EXT_INT0(void) interrupt 0
1159          {
1160   1              
1161   1      }
1162          
1163          void EXT_INT1(void) interrupt 2
1164          {
1165   1              
1166   1      }
1167          void P30_init(void){
1168   1              P30_Input_Mode;
1169   1              set_P3S_0;
1170   1      //      set_IT0;
C51 COMPILER V9.54   COUNT                                                                 02/22/2019 20:34:36 PAGE 20  

1171   1      //      set_EX0;
1172   1      //      
1173   1      //      Enable_BIT0_RasingEdge_Trig;
1174   1              PICON|=0x04;PINEN&=0xFE;PIPEN|=0x01;
1175   1              Enable_INT_Port3;
1176   1              set_EPI;
1177   1              
1178   1              set_EA;
1179   1      }
1180          void exti1_init(void){
1181   1              P17_Input_Mode;
1182   1              set_P1S_7;
1183   1              set_EX1;
1184   1              set_EA;
1185   1      }
1186          void Enter_DPD(void)
1187          {
1188   1              //P17
1189   1              P30_init();
1190   1              exti1_init();
1191   1              
1192   1              set_PD;
1193   1              
1194   1              PICON  = PICON & 0xFE;
1195   1                                      
1196   1              clr_EX0;
1197   1              clr_EX1;
1198   1              clr_EPI;
1199   1      }
1200          
1201          void main_loop(void)
1202          {
1203   1              clr_EPI;
1204   1              OLED_Init();
1205   1              OLED_Clear();
1206   1              KeyInit();
1207   1              //read sys struct from ldrom
1208   1              getdata(SysStructLen,DATA_START_ADDR,(unsigned char *)&sysinfo);
1209   1              stage_loopcnt = 0;
1210   1              sysinfo.isneedinitstage = 1;
1211   1              powercnt = 0;
1212   1              isdisplaybaticon = 0;
1213   1              batlevel = 0xff;
1214   1              val = 0;
1215   1              initADC();      
1216   1              while(!GETKEY);
1217   1              while(1)
1218   1              {
1219   2                      KeyScan();
1220   2                      
1221   2                      if ((sysinfo.isinitsys != 0xA5)||(sysinfo.sysloop == SYSINIT))
1222   2                      {
1223   3                              //clr sysinfo
1224   3                              sysinfo.language = CHINESE;
1225   3                              sysinfo.numtype = ARABNUM;
1226   3                              sysinfo.totalcnt = 0;
1227   3                              sysinfo.isinitsys = 0xA5;
1228   3                              sysinfo.sysloop = SELECT_LANGUAGE;
1229   3                              sysinfo.lastpower = 0xFF;
1230   3                              batlevel = 0xff;
1231   3                              //Display power on stage
1232   3                              OLED_Set_Pos(7,1);
C51 COMPILER V9.54   COUNT                                                                 02/22/2019 20:34:36 PAGE 21  

1233   3                              Draw_BMP(12,1,12+8,3,font_A_Z + ('K' - 'A')*16);
1234   3                              Draw_BMP(20,1,20+16,3,font_CHN + (SAN)*32);
1235   3                              Draw_BMP(36,1,36+8,3,font_A_Z + ('W' - 'A')*16);
1236   3                              Draw_BMP(44,1,44+8,3,font_A_Z + ('A' - 'A')*16);
1237   3                              
1238   3                              powercnt = 0;
1239   3                              Erase_LDROM(512,0);
1240   3                              Erase_LDROM(512,512);   
1241   3      //                      initADC();
1242   3      //                      sysinfo.lastpower = getbatlever(P30);
1243   3                              while(powercnt<400);
1244   3                              powercnt=0;
1245   3                              sysinfo.isneedinitstage = 1;
1246   3                              
1247   3                              OLED_CLS_Windows(12,1,52,3);
1248   3                      }
1249   2                      SysLoop();
1250   2      
1251   2                      if (get_battery_time >= 200)
1252   2                      {
1253   3                              set_EADC;
1254   3                              get_battery_time = 0;
1255   3                      }
1256   2                      //power mode
1257   2                      if (powercnt >= POWER_CNT1)
1258   2                      {
1259   3                              
1260   3                              //close OLED
1261   3                              OLED_Display_Off();
1262   3                              //OLED power down
1263   3                              //save DATA 
1264   3                              if ((sysinfo.sysloop == RST_CNT) ||(sysinfo.sysloop == RST_SYS))
1265   3                                      sysinfo.sysloop = CNT_STAGE;
1266   3                              savedata(SysStructLen,DATA_START_ADDR,(unsigned char *)&sysinfo);
1267   3      
1268   3                              Set_All_GPIO_Quasi_Mode;
1269   3                              clr_ADCEN;
1270   3      
1271   3                              
1272   3                              P14_OpenDrain_Mode;
1273   3                              P14 = 0;
1274   3                              Enter_DPD();
1275   3                              powercnt = 0;
1276   3                              initADC();
1277   3                              return;
1278   3                      }
1279   2              }
1280   1      }
1281          
1282          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   4597    ----
   CONSTANT SIZE    =     42    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     60      76
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      2    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
